"use strict";(self.webpackChunkdouyin_web=self.webpackChunkdouyin_web||[]).push([["25432"],{894570:function(e,t,i){e.exports=i.p+"bfc8d63b2e52161f.module.wasm"},640345:function(e,t,i){i.d(t,{ZP:function(){return l}});var s=i(134761);i(874386),i(268917);var r=i(828578);let a={debug:1,log:2,warn:3,error:4},n=!1,o=2;try{let e=localStorage.getItem(r.ct.PLAYER_LOG),t=Number(e);!isNaN(t)&&t>=a.debug&&a.error}catch(e){}class l{debug(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];l.loggerHandle("debug",...t)}log(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];l.loggerHandle("log",...t)}warn(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];l.loggerHandle("warn",...t)}error(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];l.loggerHandle("error",...t)}table(e){}static setLevel(e){l.level=e}static setEnable(e){l.enable=e}static setLoggerSize(e){l.maxSize=e}set loggerID(e){e&&(this._id=e)}get loggerID(){return this._id}static logCache(e){if(l.size+=e.length,l.logTextArray.push(e),l.size>l.maxSize){let e=l.logTextArray.shift();e&&(l.size-=e.length)}}static loggerHandle(e){for(var t=arguments.length,i=Array(t>1?t-1:0),s=1;s<t;s++)i[s-1]=arguments[s];let r=a[e];if(!r)return;let n=`${i.join(" ")}`;r>=l.level&&(l.logCache(n),l.enable&&console[e](n))}static getLoggerCache(){return l.logTextArray.join("\n")}static reset(){l.logTextArray=[],l.size=0}constructor(e){return(0,s._)(this,"name",void 0),(0,s._)(this,"_id",void 0),this.name=e,new Proxy(this,{get:(e,t)=>{var i;if("function"!=typeof this[t])return this[t];return null===(i=this[t])||void 0===i?void 0:i.bind(console,`[${function(){let e=new Date;return e.toISOString?e.toISOString():e.toLocaleString()}()}|${this._id||"-"}|${this.name}]`)}})}}(0,s._)(l,"enable",!1),(0,s._)(l,"maxSize",512e3),(0,s._)(l,"size",0),(0,s._)(l,"logTextArray",[]),(0,s._)(l,"level",a.log)},475566:function(e,t,i){i.d(t,{R:function(){return function e(){for(var t=arguments.length,i=Array(t),a=0;a<t;a++)i[a]=arguments[a];let[n,...o]=i;if(n&&!r(n))return n;let l=o.filter(e=>r(e));for(let t of l)for(let i in t)"abr"===i&&"flv"===n.protocol?n[i]=(0,s._)({},n[i],t[i]):Object.prototype.hasOwnProperty.call(t,i)&&(r(n[i])&&null!==n[i]&&r(t[i])&&null!==t[i]?e(n[i],t[i]):n[i]=t[i]);return n}}});var s=i(520739);function r(e){return"[object Object]"===Object.prototype.toString.call(e)}i(927234),i(874386)},308364:function(e,t,i){i.d(t,{v:function(){return r}});var s=i(134761);i(990921),i(874386);class r extends EventTarget{_getEventTypeMap(e,t){let i=this[`_${e}TypeMap`];return!i[t]&&(i[t]=new WeakMap),i[t]}on(e,t){let i=this._getEventTypeMap("on",e),s=i.get(t);return!s&&(s=function(e){t.call(this,e.detail,e)},i.set(t,s),this.addEventListener(e,s,{signal:this._abortController?this._abortController.signal:void 0})),()=>{i.delete(t),this.removeEventListener(e,s)}}once(e,t){let i=this._getEventTypeMap("once",e),s=i.get(t);return!s&&(s=function(e){t.call(this,e.detail,e),i.delete(t)},i.set(t,s),this.addEventListener(e,s,{signal:this._abortController?this._abortController.signal:void 0,once:!0})),()=>{i.delete(t),this.removeEventListener(e,s)}}emit(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t}))}off(e,t){let i=this._getEventTypeMap("on",e),s=this._getEventTypeMap("once",e),r=i.get(t);r&&(i.delete(t),this.removeEventListener(e,r));let a=s.get(t);a&&(s.delete(t),this.removeEventListener(e,a))}offAll(){this._onTypeMap={},this._onceTypeMap={},"undefined"!=typeof AbortController&&(this._abortController&&this._abortController.abort(),this._abortController=new AbortController)}constructor(...e){super(...e),(0,s._)(this,"_abortController","undefined"!=typeof AbortController?new AbortController:void 0),(0,s._)(this,"_onTypeMap",{}),(0,s._)(this,"_onceTypeMap",{})}}t.Z=r},989456:function(e,t,i){function s(e){globalThis.exports={};try{importScripts(e)}catch(e){return null}return globalThis.exports.default}i.d(t,{Q:function(){return s}}),i(70372)},219473:function(e,t,i){i.d(t,{P:function(){return s}});function s(e,t){let i,s=0,r=null;return function(){for(var a=arguments.length,n=Array(a),o=0;o<a;o++)n[o]=arguments[o];let l=Date.now();i=n,l-s>=t?(s=l,e.apply(this,n)):!r&&(r=setTimeout(()=>{s=Date.now(),r=null,e.apply(this,i)},t-(l-s)))}}},521612:function(e,t,i){i.d(t,{Z:function(){return a},t:function(){return r}});var s=i(134761);i(209955);var r={NETWORK:1e3,1e3:"NETWORK",NETWORK_TIMEOUT:1001,1001:"NETWORK_TIMEOUT",RTM_ICE_FAILED:1002,1002:"RTM_ICE_FAILED",DEMUX_FLV_ERROR:2e3,2e3:"DEMUX_FLV_ERROR",DEMUX_MP4_ERROR:2001,2001:"DEMUX_MP4_ERROR",DEMUX_SIDX_ERROR:2002,2002:"DEMUX_SIDX_ERROR",DECODE_VIDEO_INIT_ERROR:3e3,3e3:"DECODE_VIDEO_INIT_ERROR",DECODE_AUDIO_INIT_ERROR:3001,3001:"DECODE_AUDIO_INIT_ERROR",DECODE_VIDEO_OUTPUT_ERROR:3002,3002:"DECODE_VIDEO_OUTPUT_ERROR",DECODE_AUDIO_OUTPUT_ERROR:3003,3003:"DECODE_AUDIO_OUTPUT_ERROR",DECODE_VIDEO_DODECODE_ERROR:3004,3004:"DECODE_VIDEO_DODECODE_ERROR",DECODE_AUDIO_DODECODE_ERROR:3005,3005:"DECODE_AUDIO_DODECODE_ERROR",DECODE_VIDEO_DODECODE_TIMEOUT:3006,3006:"DECODE_VIDEO_DODECODE_TIMEOUT",DECODE_AUDIO_DODECODE_TRANSFORM_FORMAT_ERROR:3007,3007:"DECODE_AUDIO_DODECODE_TRANSFORM_FORMAT_ERROR",VEWORKER_RUNTIME_ERROR:4e3,4e3:"VEWORKER_RUNTIME_ERROR",VEWORKER_WAITINGTIMEOUT_ERROR:4001,4001:"VEWORKER_WAITINGTIMEOUT_ERROR",VEWORKER_REVEIVE_TIMEOUT:4002,4002:"VEWORKER_REVEIVE_TIMEOUT",VEWORKER_POST_MESSAGE_ERROR:4003,4003:"VEWORKER_POST_MESSAGE_ERROR",VEWORKER_POST_MESSAGE_CLONE_ERROR:4004,4004:"VEWORKER_POST_MESSAGE_CLONE_ERROR",RENDER_WORKLET_INIT_ERROR:5e3,5e3:"RENDER_WORKLET_INIT_ERROR",RENDER_WORKLET_RUNTIME_ERROR:5001,5001:"RENDER_WORKLET_RUNTIME_ERROR",RENDER_VIDEOTRACK_INIT_ERROR:5002,5002:"RENDER_VIDEOTRACK_INIT_ERROR",RENDER_VIDEO_WRITER_ERROR:5003,5003:"RENDER_VIDEO_WRITER_ERROR",RENDER_AUDIO_WRITER_ERROR:5004,5004:"RENDER_AUDIO_WRITER_ERROR",VIDEO_TRACK_ERROR:6e3,6e3:"VIDEO_TRACK_ERROR",AUDIO_TRACK_ERROR:6001,6001:"AUDIO_TRACK_ERROR",MEDIA_ERR_ABORTED:9001,9001:"MEDIA_ERR_ABORTED",MEDIA_ERR_NETWORK:9002,9002:"MEDIA_ERR_NETWORK",MEDIA_ERR_DECODE:9003,9003:"MEDIA_ERR_DECODE",MEDIA_ERR_SRC_NOT_SUPPORTED:9004,9004:"MEDIA_ERR_SRC_NOT_SUPPORTED",MEDIA_ERR_CODEC_NOT_SUPPORTED:9005,9005:"MEDIA_ERR_CODEC_NOT_SUPPORTED",MEDIA_ERR_URL_EMPTY:9006,9006:"MEDIA_ERR_URL_EMPTY",RTM_NOT_SUPPORTED:9007,9007:"RTM_NOT_SUPPORTED",RTM_SET_DESCRIPTION_ERROR:9008,9008:"RTM_SET_DESCRIPTION_ERROR",OTHER:9999,9999:"OTHER"};class a extends Error{static create(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",r=arguments.length>4?arguments[4]:void 0,n=arguments.length>5?arguments[5]:void 0,o=arguments.length>6?arguments[6]:void 0;return new a(e,t,i,s,r,n,o)}static network(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(null==e?void 0:e.response){var i,s;(null==e?void 0:null===(i=e.response)||void 0===i?void 0:i.url)&&(t.url=e.response.url),(null==e?void 0:null===(s=e.response)||void 0===s?void 0:s.status)&&(t.httpCode=e.response.status)}return new a((null==e?void 0:e.isTimeout)?r.NETWORK_TIMEOUT:r.NETWORK,null==e?void 0:e.message,t)}constructor(e,t,i,r,a,n,o){super(t),(0,s._)(this,"code",void 0),(0,s._)(this,"message",void 0),(0,s._)(this,"ext",void 0),(0,s._)(this,"log",void 0),(0,s._)(this,"errorType",void 0),(0,s._)(this,"httpCode",void 0),(0,s._)(this,"url",void 0),this.code=e,this.message=t,i&&(this.ext=i),r&&(this.log=r),a&&(this.errorType=a),n&&(this.httpCode=n),o&&(this.url=o)}}},276578:function(e,t,i){i.d(t,{Z:function(){return g}});var s=i(134761),r=i(520739),a=i(878389);i(429532),i(112587),i(17322),i(560401),i(779566),i(69896),i(416555),i(404948),i(874386),i(250440),i(70372);var n=i(308364),o=i(943186),l=i(640345),h=i(219473),d=i(828578),_=i(522544),u=i(548548),c=i(486925),m=i(754448);let p=new l.ZP("WorkerSink");class g extends n.v{static get codecConfig(){return this._codecCfg}throttleEventEmit(e,t,i){let s=`${e}_${t}`;!this._throttleEmitMap.has(s)&&this._throttleEmitMap.set(s,(0,h.P)(t=>{this.emit(e,"function"==typeof t?t():t)},t)),this._throttleEmitMap.get(s)(i)}enrichEvtMsg(e,t){return t.instanceId&&(e.instanceId=t.instanceId),e}postMsgToMain(e,t){this.instanceId&&(e.instanceId=this.instanceId),self.postMessage(e,t||[])}_bindWorkerEvent(){self.addEventListener("message",this._handleMessage),this.on(u.Zo.ISREADY,this.onReady),this.on(u.Zo.STARTPLAY,this.onStartPlay),this.on(u.Zo.TRANSMIT_LOG,this.onTransmitLog),this.on(u.Zo.PROTOCOL_CONFIG,this.onProtocolConfig),this.on(u.Zo.LOAD_STREAM,this.onLoad),this.on(u.Zo.SEAMLESS_LOAD_STREAM,this.onSeamlessLoad),this.on(u.Zo.CANCEL_SWITCH,this.onSwitchCancel),this.on(u.Zo.PLAY,this.onPlay),this.on(u.Zo.PAUSE,this.onPause),this.on(u.Zo.MUTED_SET,this.onMutedSet),this.on(u.Zo.LOOP_CHANGE,this.onLoopChange),this.on(u.Zo.CURRENT_TIME,this.onCurrentTime),this.on(u.Zo.PLAYBACKRATE,this.onRateChange),this.on(u.Zo.WRITABLE,this.onWritable),this.on(u.Zo.ERROR,this.onError),this.on(u.Zo.FREQUENT_STATISTICS,this.onFrequentStatistics),this.on(u.Zo.DESTROY,this.onPlayerDestroy),this.on(u.Zo.VISIBILITYSTATE,this.onVisibilitychange),this.on(u.Zo.VOLUMEBALANCE_UPDATE,this.onVolumeBalanceUpdate),this.on(u.Zo.RESET,this.onReset),this._transEventDown(u.Zo.MESSAGE_TRANS_LOG),this._transEventDown(u.Zo.MESSAGE_INIT_RENDER),this._transEventDown(u.Zo.MESSAGE_EVENT_RATECHANGE),this._transEventDown(u.Zo.MESSAGE_FIRSTFRAME),this._transEventDown(u.Zo.MESSAGE_STATISTICS),this._transEventDown(u.Zo.PROCESS_ERROR),this._transVEErrorDown(u.Zo.MESSAGE_EVENT_VEERROR),this._transEventDown(u.Zo.MESSAGE_EVENT_LOADEDMETADATA),this._transEventDown(u.Zo.MESSAGE_EVENT_DURATIONCHANGE),this._transEventDown(u.Zo.MESSAGE_EVENT_WAITING),this._transEventDown(u.Zo.MESSAGE_EVENT_PROGRESS),this._transEventDown(u.Zo.MESSAGE_EVENT_SEEKING),this._transEventDown(u.Zo.MESSAGE_EVENT_SEEKED),this._transEventDown(u.Zo.MESSAGE_EVENT_ENDED),this._transEventDown(u.Zo.MESSAGE_EVENT_PLAYING),this._transEventDown(u.Zo.MESSAGE_EVENT_CANPLAY),this._transEventDown(u.Zo.MESSAGE_EVENT_ISREADY),this._transEventDown(u.Zo.MESSAGE_EVENT_RECEIVESUCCESS),this._transEventDown(u.Zo.AV_UNSYNC),this._transEventDown(u.Zo.MESSAGE_EVENT_DROPFRAMES),this._transEventDown(u.Zo.MESSAGE_EVENT_SEGMENT_DONE),this._transVEErrorDown(m.o.ERROR),this._transEventDown(m.o.LOADRETRY),this._transEventDown(m.o.TTFB),this._transEventDown(m.o.RESPONSEHEADERS),this._transEventDown(m.o.METADATA),this._transEventDown(m.o.CHASE_FRAME),this._transEventDown(m.o.KEYFRAME),this._transEventDown(m.o.SWITCH_START),this._transEventDown(m.o.SWITCH_COMPLETE),this._transEventDown(m.o.SWITCH_ERROR),this._transEventDown(m.o.PROP_SPEED),this._transEventDown(m.o.PROP_ENDEDSTATUS),this._transEventDown(m.o.CHANGE_URL),this._transEventDown(m.o.CHANGE_BITRATE_SUCCESS),this._transEventDown(m.o.RTM_NETWORK),this._transEventDown(m.o.DELETE_PCDN_URL),this._transSEIDown();for(let e=0;e<u._8.length;e++)this.on(u._8[e],t=>{self.postMessage((0,r._)({type:u._8[e]},t))})}onProtocolConfig(e){e.veConfig&&(g._codecCfg=Object.assign({},g._codecCfg,e.veConfig))}onReady(){}onReset(){}onStartPlay(){}onTransmitLog(){this.emit(d.Xe.ADD_INFO_TO_LOG),setTimeout(()=>{this.emit(u.Zo.MESSAGE_TRANS_LOG,{data:`[${p.name}] worker thread:
${l.ZP.getLoggerCache()}`})},0)}onLoad(e){}onSeamlessLoad(e){}onSwitchCancel(){}onPlay(e){this.stateManager&&!1!==this.stateManager.get("paused")&&this.stateManager.set("paused",!1),this.onLoopChange({loop:e.loop}),this.onRateChange({rate:e.playbackRate}),this.onMutedSet({muted:!!e.muted,autoplayPolicy:!!e.autoplayPolicy})}onPause(){this.stateManager&&!0!==this.stateManager.get("paused")&&this.stateManager.set("paused",!0)}onMutedSet(e){this.stateManager&&this.stateManager.get("muted")!==e.muted&&this.stateManager.set("muted",e.muted),this.stateManager&&this.stateManager.get("autoplayPolicy")!==e.autoplayPolicy&&this.stateManager.set("autoplayPolicy",e.autoplayPolicy)}onLoopChange(e){if("boolean"==typeof e.loop)this.stateManager&&this.stateManager.get("loop")!==e.loop&&(p.log("loop changed:",e.loop),this.stateManager.set("loop",e.loop))}onCurrentTime(e){}onRateChange(e){var t,i;if("number"==typeof e.rate&&(!this.stateManager||this.stateManager.get("playbackRate")!==e.rate))null===(t=this.stateManager)||void 0===t||t.set("playbackRate",e.rate),null===(i=this.stateManager)||void 0===i||i.set("rateChanged",!0)}onWritable(e){}onError(){}onFrequentStatistics(e){}onVolumeBalanceUpdate(e){var t;null===(t=this.stateManager)||void 0===t||t.set("volumeBalance",e.param)}onPlayerDestroy(e){var t;e.isDestroy&&(null===(t=this.stateManager)||void 0===t||t.resetStates())}onVisibilitychange(e){}_transEventDown(e){this.on(e,t=>{self.postMessage((0,r._)({type:e},t))})}_transFFEventDown(e){this.on(e,t=>{self.postMessage((0,r._)({type:e},t))})}_transVEErrorDown(e){this.on(e,t=>{var i;null===(i=this.stateManager)||void 0===i||i.set("error",t);t.log=l.ZP.getLoggerCache(),self.postMessage((0,r._)({type:e},t))})}_transSEIDown(){this.on(m.o.SEI,e=>{let t=new Uint8Array(e.content);self.postMessage((0,a._)((0,r._)({type:m.o.SEI},e),{content:t}),[t.buffer])})}transWritableComponentDown(e){self.postMessage((0,r._)({type:u.Zo.DOWN_WRITABLE},e),[null==e?void 0:e.audioWritable].filter(Boolean))}transInitRender(e){self.postMessage((0,r._)({type:u.Zo.MESSAGE_INIT_RENDER},e),[null==e?void 0:e.audioWritable].filter(Boolean))}destroy(){this._throttleEmitMap.clear(),self.removeEventListener("message",this._handleMessage),this.offAll()}constructor(e,t){super(),(0,s._)(this,"instanceId",""),(0,s._)(this,"stateManager",void 0),(0,s._)(this,"_throttleEmitMap",new Map),(0,s._)(this,"_handleMessage",e=>{let{data:t}=e;if(t.broadcastChannelName&&(0,o.U3)(t.broadcastChannelName),!![u.Zo.ISREADY,u.Zo.PROTOCOL_CONFIG].includes(t.type)||!t.instanceId||""===this.instanceId||t.instanceId===this.instanceId){if(Object.prototype.hasOwnProperty.call(this,"isPlayerWorker")){if("boolean"==typeof t.enableLog){var i;l.ZP.setEnable(t.enableLog),t.logLevel&&l.ZP.setLevel(t.logLevel),p.loggerID=null===(i=t.mediaInfo)||void 0===i?void 0:i.id}![u.Zo.RTM_STATS].includes(t.type)&&p.log(`receive message: ${t.type}`)}if(this.emit(t.type,t),"message-port"===e.data.type){let t=e.ports[0];globalThis.messageChannelPort=t,t.start()}}}),this.instanceId=e||"",!t&&(t=new _.Z),this.stateManager=t,this._bindWorkerEvent()}}(0,s._)(g,"_codecCfg",(0,c.AF)())},498722:function(e,t,i){i.d(t,{Z:function(){return n}});var s=i(134761),r=i(640345),a=i(548548);class n{get heAAC(){return 2!==this.objectType||22050===this.sampleRate}get sampleDuration(){return Math.floor(1024/this.sampleRate*1e6)}get sampleDurationToPts(){return this.sampleDuration/a.Ll*this.timescale}get description(){return`${this.codec}/${this.config}`}updateDecodedOutput(e){!this.outSampleRate&&(this.outSampleRate=e.sampleRate,this.outNbOfSamples=e.numberOfFrames,this.outChannelCount=e.numberOfChannels,this.logger.log(`AudioData output: ar:${this.outSampleRate}, ac:${this.outChannelCount}, samplesPreFrame:${this.outNbOfSamples}`))}match(e){return this.codec===e.codec&&this.sampleRate===e.sampleRate&&this.channelCount===e.channelCount&&this.objectType===e.objectType}constructor(e){(0,s._)(this,"logger",new r.ZP("AudioMeta")),(0,s._)(this,"codec",""),(0,s._)(this,"sampleRate",0),(0,s._)(this,"channelCount",0),(0,s._)(this,"objectType",0),(0,s._)(this,"timescale",0),(0,s._)(this,"outSampleRate",0),(0,s._)(this,"outNbOfSamples",0),(0,s._)(this,"outChannelCount",0),(0,s._)(this,"dur",0),(0,s._)(this,"config",[]),this.codec=e.codec,this.sampleRate=e.sampleRate,this.channelCount=e.channelCount,this.objectType=e.objectType,this.timescale=e.timescale,this.config=e.config,this.dur=e.duration}}},927919:function(e,t,i){i.d(t,{Z:function(){return a}});var s=i(134761);i(927234);var r=i(548548);class a{get frameRate(){return this._frameRate}get sampleDurationToPts(){return this.sampleDuration/r.Ll*this.timescale}get sampleDuration(){return Math.floor(1e3/this._frameRate*1e3)}get description(){return`${this.codec}/${this.width}/${this.height}`}match(e){var t,i;return this.codec===e.codec&&this.width===e.width&&this.height===e.height&&this.timescale===e.timescale&&this.pps.toString()===e.pps.toString()&&this.sps.toString()===e.sps.toString()&&(null===(t=this.vps)||void 0===t?void 0:t.toString())===(null===(i=e.vps)||void 0===i?void 0:i.toString())}constructor(e,t){(0,s._)(this,"codec",""),(0,s._)(this,"width",0),(0,s._)(this,"height",0),(0,s._)(this,"timescale",0),(0,s._)(this,"vps",[]),(0,s._)(this,"sps",[]),(0,s._)(this,"pps",[]),(0,s._)(this,"hvcC",null),(0,s._)(this,"vvcC",null),(0,s._)(this,"_frameRate",25),(0,s._)(this,"dur",0),this.codec=e.codec,this.width=e.width,this.height=e.height,this.timescale=e.timescale,this.vps=e.vps,this.pps=e.pps,this.sps=e.sps,this.hvcC=e.hvcC,this.vvcC=e.vvcC,this.dur=e.duration,t&&(t.flvScriptSamples.forEach(e=>{var t,i,s,r;(null===(i=e.data)||void 0===i?void 0:null===(t=i.onMetaData)||void 0===t?void 0:t.framerate)&&(this._frameRate=null===(r=e.data)||void 0===r?void 0:null===(s=r.onMetaData)||void 0===s?void 0:s.framerate)}),!this._frameRate&&e.fpsNum&&(this._frameRate=e.fpsNum/e.fpsDen))}}},35061:function(e,t,i){i(268917)},108400:function(e,t,i){i.d(t,{Fc:function(){return n},WE:function(){return a},wb:function(){return r}});var s=i(134761);i(209955);let r={NETWORK:"network",NETWORK_TIMEOUT:"network_timeout",NETWORK_FORBIDDEN:"network_forbidden",NETWORK_NOTFOUND:"network_notfound",DEMUX:"demux",OTHER:"other",RUNTIME:"runtime",SUB_TYPES:{FLV:"FLV",MP4:"MP4"}},a={[r.NETWORK]:2100,[r.NETWORK_TIMEOUT]:2101,[r.NETWORK_FORBIDDEN]:2103,[r.NETWORK_NOTFOUND]:2104,[r.DEMUX]:{FLV:3100},[r.OTHER]:8e3,[r.RUNTIME]:{NO_CANPLAY_ERROR:9001,BUFFERBREAK_ERROR:9002,WAITING_TIMEOUT_ERROR:9003}};class n extends Error{static network(e){var t;return new n((null==e?void 0:e.isTimeout)?r.NETWORK_TIMEOUT:r.NETWORK,null,e instanceof Error?e:null,{url:null==e?void 0:e.url,response:null==e?void 0:e.response,httpCode:null==e?void 0:null===(t=e.response)||void 0===t?void 0:t.status})}constructor(e,t,i,n,o){super(o||(null==i?void 0:i.message)),(0,s._)(this,"errorType",void 0),(0,s._)(this,"originError",void 0),(0,s._)(this,"ext",void 0),(0,s._)(this,"errorCode",void 0),this.errorType=e===r.NETWORK_TIMEOUT?r.NETWORK:e,this.originError=i,this.ext=n,this.errorCode=a[e][t]||a[e],!this.errorCode&&(this.errorType=r.OTHER,this.errorCode=a[this.errorType])}}},243200:function(e,t,i){i.d(t,{J_:function(){return a},Kn:function(){return r}}),i(927234);let s=Object.prototype.toString;function r(e){return null!==e&&"object"==typeof e}function a(e){return"[object Date]"===s.call(e)}},468071:function(e,t,i){i.d(t,{i:function(){return n}});var s=i(520739),r=i(878389),a=i(487575);function n(e){var t;return(0,r._)((0,s._)({timeout:3e3,request:null,onTimeout:void 0,onProgress:void 0,transformRequest:void 0,transformResponse:void 0,transformError:void 0,responseType:a.UN.ARRAY_BUFFER,range:void 0,url:void 0,params:void 0,method:"GET",headers:{},body:void 0,mode:void 0,credentials:void 0,cache:void 0,redirect:void 0,referrer:void 0,referrerPolicy:void 0,integrity:void 0,onProcessMinLen:0,maxReaderInterval:3e3},e),{retryConfig:{retryCount:(null==(t=e.retryConfig)?void 0:t.retryCount)||2,retryDelay:(null==t?void 0:t.retryDelay)||1e3,noRetryList:(null==t?void 0:t.noRetryList)||[]}})}},37735:function(e,t,i){i.d(t,{j:function(){return l}});var s=i("134761");i("413806"),i("826893"),i("675373"),i("112587"),i("17322"),i("560401"),i("779566"),i("69896"),i("416555"),i("404948"),i("779788");var r=i("640345");i("209955");class a extends Error{constructor(e,t,i,r){super(r),(0,s._)(this,"retryCount",0),(0,s._)(this,"isTimeout",!1),(0,s._)(this,"startTime",0),(0,s._)(this,"endTime",0),(0,s._)(this,"options",{}),(0,s._)(this,"url",void 0),(0,s._)(this,"request",void 0),(0,s._)(this,"response",void 0),(0,s._)(this,"message",void 0),this.url=e,this.request=t,this.response=i,this.message=r}}var n=i("381414"),o=i("487575");class l{load(e){var t,i,s,r,l;let{url:h="",stream:d,timeout:_,responseType:u,onProgress:c,id:m,onTimeout:p,onCancel:g,range:f,transformResponse:v,request:E,params:T,method:y,headers:R,body:S,mode:b,credentials:D,cache:w,redirect:A,referrer:C,referrerPolicy:O,onProcessMinLen:M,retry:I,retryDelay:k,maxReaderInterval:P,priOptions:L}=e;this._aborted=!1,this._onProcessMinLen="number"==typeof M?M:0,this._maxReaderInterval="number"==typeof P?P:0,this._onCancel=g,this._abortController="undefined"!=typeof AbortController?new AbortController:void 0,this._running=!0,this._id=`${m}`,this._logger.loggerID=this._id,this._range=f||[0,0];let F=this._range;f&&this._receivedLength>0&&(F=[this._range[0]+this._receivedLength,this._range[1]],this._logger.warn(`[fetch load start fix range] ${null===(r=this._range)||void 0===r?void 0:r[0]}-${null===(l=this._range)||void 0===l?void 0:l[1]},fixRange ${null==F?void 0:F[0]}-${null==F?void 0:F[1]}`)),this._priOptions=L||{};let x={method:y,headers:R,body:S,mode:b,credentials:D,cache:w,redirect:A,referrer:C,referrerPolicy:O,signal:null===(t=this._abortController)||void 0===t?void 0:t.signal},B=!1;clearTimeout(this._timeoutTimer),this.url=h,h=(0,n.G7)(h,T);let N=(0,n.Gu)(F);if(N){if(R=E?E.headers:x.headers=x.headers||(Headers?new Headers:{}),Headers&&R instanceof Headers)R.append("Range",N);else if(R)R.Range=N}_&&(this._timeoutTimer=setTimeout(()=>{if(B=!0,this.cancel(),p){let e=new a(h,x,null,"timeout");e.isTimeout=!0,p(e,{id:this._id,range:this._range,priOptions:this._priOptions})}},_));let U=Date.now();return this._logger.log(`[fetch load start] range ${null==f?void 0:f[0]}-${null==f?void 0:f[1]}, ${null==h?void 0:null===(i=h.split("?"))||void 0===i?void 0:i[0]}`),null===(s=this._speedSamplerManager)||void 0===s||s.start(this._priOptions.loadType),new Promise((t,i)=>{(d?new Promise(e=>{let t=new Response(d);Object.defineProperty(t,"url",{value:h}),e(t)}):fetch(E||h,E?void 0:x)).then(async e=>{var s,r;let l;if(clearTimeout(this._timeoutTimer),this._aborted||!this._running)return;if(v&&(e=v(e,h)||e),!e.ok)throw new a(h,x,e,"bad network response");let d=Date.now();if(u===o.UN.TEXT)l=await e.text(),this._running=!1;else if(u===o.UN.JSON)l=await e.json(),this._running=!1;else{if(c){this.resolve=t,this.reject=i,this._loadChunk(e,c,U,d);return}l=new Uint8Array(l=await e.arrayBuffer()),this._running=!1}this._logger.log(`[fetch load end] range,${null==f?void 0:f[0]}-${null==f?void 0:f[1]}`),null===(s=this._speedSamplerManager)||void 0===s||s.addBytes(null==l?void 0:l.byteLength,this._priOptions.loadType),null===(r=this._speedSamplerManager)||void 0===r||r.end(this._priOptions.loadType),t((0,n.rO)(l,!0,e,{priOptions:this._priOptions,startTime:U,firstByteTime:d,id:this._id,range:this._range}))}).catch(t=>{if(clearTimeout(this._timeoutTimer),this._running=!1,!this._aborted||B){if(this._retryCount++,this._retryCount<=I){clearTimeout(this._retryTimer),this._logger.warn("[task request setTimeout],retry",this._retryCount),this._retryTimer=setTimeout(()=>{this.load(e)},k);return}(t=t instanceof a?t:new a(h,x,null,B?"timeout":null==t?void 0:t.message)).startTime=U,t.endTime=Date.now(),t.isTimeout=B,t.options={id:this._id,range:this._range,priOptions:this._priOptions},i(t)}})})}async cancel(){var e,t,i;if(null===(i=this._logger)||void 0===i||i.log("fetch cancel",null===(e=this._range)||void 0===e?void 0:e[0],null===(t=this._range)||void 0===t?void 0:t[1]),!this._aborted){if(this._aborted=!0,this._running=!1,this._maxChunkWaitTimer&&(clearTimeout(this._maxChunkWaitTimer),this._maxChunkWaitTimer=null),this._reader){try{await this._reader.cancel()}catch(e){}this._reader=void 0}if(this._abortController){try{this._abortController.abort()}catch(e){}this._abortController=void 0}this._onCancel&&this._onCancel({id:this._id,range:this._range,priOptions:this._priOptions})}}_loadChunk(e,t,i,s){let r,o,l;if(!e.body||!e.body.getReader){this._running=!1;let t=new a(e.url,null,e,"onProgress of bad response.body.getReader");t.options={id:this._id,range:this._range,priOptions:this._priOptions},this.reject(t);return}this._onProcessMinLen>0&&(this._cache=new Uint8Array(2097152),this._writeIdx=0);let h=this._reader=e.body.getReader(),d=async()=>{var _,u,c,m,p;let g;o=Date.now();try{r=await h.read(),l=Date.now()}catch(e){l=Date.now(),!this._aborted&&(this._running=!1,e.options={id:this._id,range:this._range,priOptions:this._priOptions,readLen:this._receivedLength},this.reject(e));return}let f=((null===(_=this._range)||void 0===_?void 0:_.length)>0?this._range[0]:0)+this._receivedLength;if(this._aborted){this._running=!1,t(void 0,!1,{range:[f,f],id:this._id,startTime:i,endTime:Date.now(),firstByteTime:s,priOptions:this._priOptions},e);return}let v=r.value?r.value.byteLength:0;if(v&&(null===(u=this._speedSamplerManager)||void 0===u||u.addBytes(v,this._priOptions.loadType)),this._receivedLength+=v,this._onProcessMinLen>0){if(this._writeIdx+v>=this._onProcessMinLen||r.done)(g=new Uint8Array(this._writeIdx+v)).set(this._cache.slice(0,this._writeIdx),0),v>0&&g.set(r.value,this._writeIdx),this._writeIdx=0;else if(v>0&&this._writeIdx+v<2097152)this._cache.set(r.value,this._writeIdx),this._writeIdx+=v;else if(v>0){let e=new Uint8Array(this._writeIdx+v+2048);e.set(this._cache.slice(0,this._writeIdx),0),v>0&&e.set(r.value,this._writeIdx),this._writeIdx+=v,delete this._cache,this._cache=e}}else g=r.value;(g&&g.byteLength>0||r.done)&&(this._maxChunkWaitTimer&&(clearTimeout(this._maxChunkWaitTimer),this._maxChunkWaitTimer=null),t(g,r.done,{range:[this._range[0]+this._receivedLength-(g?g.byteLength:0),this._range[0]+this._receivedLength],id:this._id,startTime:o,endTime:l,st:i,firstByteTime:s,readLen:this._receivedLength,priOptions:this._priOptions},e)),r.done?(null===(c=this._speedSamplerManager)||void 0===c||c.end(this._priOptions.loadType),this._running=!1,this._logger.log("[fetchLoader onProgress end],task,",null===(m=this._range)||void 0===m?void 0:m[0],"-",null===(p=this._range)||void 0===p?void 0:p[1],",done,",r.done),this.resolve((0,n.rO)(r,!0,e,{priOptions:this._priOptions,startTime:i,firstByteTime:s,id:this._id,range:this._range}))):(this._maxReaderInterval>0&&!this._maxChunkWaitTimer&&(this._maxChunkWaitTimer=setTimeout(async()=>{if(this._aborted)return;await this.cancel(),this._running=!1,this._logger.warn("no data receive long time!, so retry",JSON.stringify(this._range),",receiveLen",this._receivedLength);let t=new a(e.url,null,e,`${this._maxReaderInterval} ms no data receive! cancel load`);t.startTime=i,t.endTime=Date.now(),t.isTimeout=!0,t.options={id:this._id,range:this._range,priOptions:this._priOptions,readLen:this._receivedLength},this.reject(t)},this._maxReaderInterval)),d())};d()}setSpeedSample(e){this._speedSamplerManager=e}get receiveLen(){return this._receivedLength}get running(){return this._running}set running(e){this._running=e}static isSupported(){return"undefined"!=typeof fetch}constructor(){(0,s._)(this,"_abortController",void 0),(0,s._)(this,"_timeoutTimer",null),(0,s._)(this,"_reader",void 0),(0,s._)(this,"_aborted",!1),(0,s._)(this,"_id","-1"),(0,s._)(this,"_range",[0,0]),(0,s._)(this,"_receivedLength",0),(0,s._)(this,"_running",!1),(0,s._)(this,"_logger",new r.ZP("FetchLoader")),(0,s._)(this,"_retryCount",0),(0,s._)(this,"_retryTimer",void 0),(0,s._)(this,"_onProcessMinLen",0),(0,s._)(this,"_onCancel",void 0),(0,s._)(this,"_priOptions",{}),(0,s._)(this,"_cache",void 0),(0,s._)(this,"resolve",void 0),(0,s._)(this,"reject",void 0),(0,s._)(this,"_writeIdx",0),(0,s._)(this,"_maxReaderInterval",0),(0,s._)(this,"_maxChunkWaitTimer",void 0),(0,s._)(this,"_speedSamplerManager",void 0),(0,s._)(this,"url","")}}},381414:function(e,t,i){i.d(t,{G7:function(){return n},Gu:function(){return r},rO:function(){return o}}),i(284961),i(826893),i(779788);var s=i(243200);function r(e){if(!e||null===e[0]||void 0===e[0]||0===e[0]&&(null===e[1]||void 0===e[1]))return;let t="bytes="+e[0]+"-";return e[1]&&e[1]!==1/0&&(t+=e[1]),t}function a(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function n(e,t){let i;if(!e)return"";if(!t)return e;let r=Object.keys(t).map(e=>{if(null!=(i=t[e]))return Array.isArray(i)?e+="[]":i=[i],i.map(t=>((0,s.J_)(t)?t=t.toISOString():(0,s.Kn)(t)&&(t=JSON.stringify(t)),`${a(e)}=${a(t)}`)).join("&")}).filter(Boolean).join("&");if(r){let t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+r}return e}function o(e,t,i,s){return(s=s||{}).endTime=Date.now(),{data:e,done:t,response:i,options:s}}},930512:function(e,t,i){i.d(t,{y:function(){return l}});var s=i("134761");i("874386"),i("268917"),i("527785");var r=i("308364"),a=i("943186"),n=i("487575");class o extends r.Z{get type(){return this._type}get gAvgSpeed(){return this._gAvgSpeed}end(){this._intervalBytes>0&&(this._intervalMilSec=Date.now()-this._startMilSec,this.addSample()),this._startMilSec=0}start(){this._startMilSec=Date.now(),this._intervalBytes=0,this._intervalMilSec=0}addSample(){if(this._intervalBytes>0){var e;(null===(e=this._intervalByteQueue)||void 0===e?void 0:e.length)>5&&(this._intervalByteQueue.shift(),this._intervalMinSecQueue.shift()),this._intervalByteQueue.push(this._intervalBytes),this._intervalMinSecQueue.push(this._intervalMilSec)}}addBytes(e){var t;this._totalBytes+=e,0===this._startMilSec?(this._startMilSec=Date.now(),this._intervalBytes+=e):Date.now()-this._startMilSec<1e3?this._intervalBytes+=e:(this._intervalMilSec=Date.now()-this._startMilSec,this._intervalBytes=e,this.addSample(),this._intervalBytes=0,this._intervalMilSec=0,this._startMilSec=Date.now()),this.emit("sample",this),null===(t=this._channel)||void 0===t||t.postMessage({type:"speedSample",data:{speed:this.currentKBps,bytes:e,timestamp:Date.now(),type:this._type}})}get currentKBps(){let e=this._intervalMilSec/1e3;return 0==e&&(e=(Date.now()-this._startMilSec)/1e3),Math.floor(this._intervalBytes/e/1024)}get averageKBps(){let e=this._intervalMinSecQueue.reduce((e,t)=>e+t,0),t=Date.now()-this._startMilSec;e<=0?e=t:e+=t;let i=e/1e3,s=this._intervalByteQueue.reduce((e,t)=>e+t,0);return 0===s?s=this._intervalBytes:s+=this._intervalBytes,Math.floor(s/i/1024)}get totalBytes(){return this._totalBytes}get gapTotalBytes(){let e=this._totalBytes-this._lastTotalBytes;return this._lastTotalBytes=this._totalBytes,e}reset(){this._startMilSec=0,this._intervalBytes=0,this._intervalMilSec=0,this._intervalByteQueue=[],this._intervalMinSecQueue=[],this._totalBytes=0,this._lastTotalBytes=0}destroy(){this.offAll(),this.reset(),this._channel&&(this._channel.removeEventListener("message",this._onChannelMsg),this._channel.close(),this._channel=void 0)}constructor(e){super(),(0,s._)(this,"_startMilSec",0),(0,s._)(this,"_intervalBytes",0),(0,s._)(this,"_intervalMilSec",0),(0,s._)(this,"_intervalByteQueue",[]),(0,s._)(this,"_intervalMinSecQueue",[]),(0,s._)(this,"_totalBytes",0),(0,s._)(this,"_lastTotalBytes",0),(0,s._)(this,"_type",n.L2.CDN),(0,s._)(this,"_channel",void 0),(0,s._)(this,"_gAvgSpeed",0),(0,s._)(this,"_onChannelMsg",e=>{let{type:t,data:i}=e.data;"speedAvg"===t&&(this._gAvgSpeed=i.value)}),this._type=e;let t=(0,a.CM)();if("undefined"!=typeof BroadcastChannel&&t){if(this._channel&&this._channel.name!==t){var i;null===(i=this._channel)||void 0===i||i.close(),this._channel=void 0}!this._channel&&(this._channel=new BroadcastChannel(t),this._channel.addEventListener("message",this._onChannelMsg))}}}class l extends r.Z{get currentKBps(){let e=0,t=0;for(let i of this.samplers.values())e+=i.currentKBps,t+=1;return Math.floor(e/t)}get averageKBps(){let e=0,t=0;for(let i of this.samplers.values())e+=i.averageKBps,t+=1;return Math.floor(e/t)}get gapTotalBytes(){let e=0;for(let t of this.samplers.values())e+=t.gapTotalBytes;return e}start(e){var t;null===(t=this.getSampler(e||n.L2.CDN))||void 0===t||t.start()}end(e){var t;null===(t=this.getSampler(e||n.L2.CDN))||void 0===t||t.end()}addBytes(e,t){let i=this.samplers.get(t||n.L2.CDN);i&&i.addBytes(e)}getSampler(e){return this.samplers.get(e||n.L2.CDN)}addSample(e){var t;null===(t=this.getSampler(e||n.L2.CDN))||void 0===t||t.addSample()}getCurrentKBps(e){var t;return(null===(t=this.getSampler(e))||void 0===t?void 0:t.currentKBps)||0}getAverageKBpsBy(e){var t;return(null===(t=this.getSampler(e))||void 0===t?void 0:t.averageKBps)||0}getGapTotalBytes(e){var t;return(null===(t=this.getSampler(e||n.L2.CDN))||void 0===t?void 0:t.gapTotalBytes)||0}reset(){for(let e of this.samplers.values())e.reset()}destroy(){if(this.samplers.size>0){for(let e of this.samplers.values())e.off("sample",this.emitSampleEvent),e.destroy();this.samplers.clear()}}constructor(){for(let e of(super(),(0,s._)(this,"samplers",new Map),(0,s._)(this,"emitSampleEvent",e=>{this.emit("sample",e)}),Object.keys(n.L2).forEach(e=>{let t=e.toLowerCase();this.samplers.set(t,new o(t))}),this.samplers.values()))e.on("sample",this.emitSampleEvent)}}},148629:function(e,t,i){i.d(t,{i:function(){return _}});var s=i("134761"),r=i("520739"),a=i("878389"),n=i("368200");i("242079"),i("851912"),i("826893"),i("927234"),i("954372"),i("675373"),i("268917");var o=i("308364"),l=i("640345"),h=i("487575");i("874386");var d=i("37735");class _ extends o.Z{get running(){return this._loader&&this._loader.running}get loader(){return this._loader}exec(){let e=this._config,{transformError:t,onRetryError:i}=e,s=(0,n._)(e,["transformError","onRetryError"]),{retryCount:o=2,retryDelay:l=1e3,noRetryList:d=[]}=this._config.retryConfig||{},_=async()=>{try{this._isChangeUrl&&(this._curUseUrl=this._urlList[0],this._isChangeUrl=!1,this.emit(h.PR,{url:this._curUseUrl})),this._retryTimer&&(clearTimeout(this._retryTimer),this._retryTimer=null);let e=await this._loader.load((0,a._)((0,r._)({},s),{url:this._curUseUrl}));this.promise.resolve(e)}catch(h){var e,n,u;if(this._loader.running=!1,this._logger.warn("[task request catch err]",h),this._canceled)return;h.retryCount=this._retryCount;let r=h;t&&(r=t(r)||r),i&&this._retryCount>0&&i(r,this._retryCount,{index:s.index,vid:s.vid,range:s.range,priOptions:s.priOptions}),this._retryCount++;let a=!0;if((null==d?void 0:d.length)>0){let e=(null==h?void 0:h.response)&&(null===(u=h.response)||void 0===u?void 0:u.status),t=null==h?void 0:h.message;for(let i=0,s;i<d.length;i++)if(s=d[i],void 0!==t||void 0!==e){if(h.isTimeout&&"timeout"===s){a=!1;break}if(s instanceof RegExp){if(s.test(t)||s.test(e)){a=!1;break}}else if(s===e||s===t){a=!1;break}}}if(a&&this._retryCount<=o){this._retryTimer&&clearTimeout(this._retryTimer),this._logger.log("[task request],retry",this._retryCount,",retry range,",s.range),this._retryTimer=setTimeout(_,l);return}if(null===(e=this._config.url)||void 0===e||e.forEach(e=>{e.src===this._curUseUrl&&(e.disable=!0)}),this._urlList.shift(),(null===(n=this._urlList)||void 0===n?void 0:n.length)>0){this._logger.log("[task request],change url retry, range,",s.range,",urlLen,",this._urlList.length),this._retryCount=0,this._isChangeUrl=!0,this._retryTimer=setTimeout(_,l);return}this.promise.reject(r)}};return _()}checkRetryIng(){return!!this._retryTimer}async cancel(){return this._retryTimer&&clearTimeout(this._retryTimer),this._retryTimer=null,this._canceled=!0,this._loader.running=!1,this._loader.cancel()}setSpeedSample(e){var t;null===(t=this._loader)||void 0===t||t.setSpeedSample(e)}get config(){return this._config}constructor(e,t){var i;super(),(0,s._)(this,"alive",void 0),(0,s._)(this,"promise",void 0),(0,s._)(this,"_curUseUrl",""),(0,s._)(this,"_loader",void 0),(0,s._)(this,"_config",void 0),(0,s._)(this,"_retryCount",void 0),(0,s._)(this,"_retryTimer",void 0),(0,s._)(this,"_canceled",void 0),(0,s._)(this,"_logger",void 0),(0,s._)(this,"_urlList",void 0),(0,s._)(this,"_isChangeUrl",void 0),e.logger=e.logger||new l.ZP("Task"),this.alive=!!e.onProgress,this.promise=function(){let e,t;let i=new Promise((i,s)=>{e=i,t=s});return i.resolve=function(){for(var t=arguments.length,i=Array(t),s=0;s<t;s++)i[s]=arguments[s];return e(...i)},i.reject=function(){for(var e=arguments.length,i=Array(e),s=0;s<e;s++)i[s]=arguments[s];return t(...i)},i}(),this._loader=new d.j,this._config=e,this._retryCount=0,this._retryTimer=null,this._canceled=!1,this._logger=e.logger,this._urlList=[],null===(i=this._config.url)||void 0===i||i.forEach(e=>{e.disable||this._urlList.push(e.src)}),this._curUseUrl=t,""!==this._curUseUrl&&this._curUseUrl&&this._curUseUrl===this._urlList[0]?this._isChangeUrl=!1:this._isChangeUrl=!0}}},487575:function(e,t,i){i.d(t,{L2:function(){return r},PR:function(){return a},UN:function(){return s}});var s={ARRAY_BUFFER:"arraybuffer",TEXT:"text",JSON:"json"},r={CDN:"cdn",PCDN:"pcdn"};let a="change_url"},171269:function(e,t,i){function s(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise(t=>setTimeout(t,e))}i.d(t,{_:function(){return s}}),i(675373)},473833:function(e,t,i){i.d(t,{Z:function(){return l}});var s,r=i("134761");i("675373"),i("882732"),i("544943"),i("874386"),i("112587"),i("17322"),i("560401"),i("779566"),i("69896"),i("416555"),i("404948"),i("429532"),i("284961"),i("826893"),i("268917"),i("209955"),i("990921"),i("950331"),i("338172"),i("927234");var a=(s="file:///opt/tiger/compile_path/src/code.byted.org/ies/douyin_web/.eden-mono/temp/node_modules/.pnpm/@byted+webplayer@0.0.2-alpha.47-4/node_modules/@byted/webplayer/es/ve/playbackrate/playbackrate.js",function(e){var t,r,a,n,o,l,h,d,_,u,c,m,p,g,f,v,E,T,y,R=void 0!==(e=e||{})?e:{},S=Object.assign;R.ready=new Promise(function(e,t){r=e,a=t});var b=S({},R),D=[],w="./this.program",A=(e,t)=>{throw t},C="";"undefined"!=typeof document&&document.currentScript&&(C=document.currentScript.src),s&&(C=s),C=0!==C.indexOf("blob:")?C.substr(0,C.replace(/[?#].*/,"").lastIndexOf("/")+1):"";R.print;var O=R.printErr||void 0;S(R,b),b=null,R.arguments&&(D=R.arguments),R.thisProgram&&R.thisProgram,R.quit&&R.quit;var M=[];R.wasmBinary&&(l=R.wasmBinary),R.noExitRuntime,"object"!=typeof WebAssembly&&U("no native wasm support detected");var I=!1;function k(e){d=e,R.HEAP8=new Int8Array(e),R.HEAP16=new Int16Array(e),R.HEAP32=new Int32Array(e),R.HEAPU8=u=new Uint8Array(e),R.HEAPU16=new Uint16Array(e),R.HEAPU32=new Uint32Array(e),R.HEAPF32=new Float32Array(e),R.HEAPF64=new Float64Array(e)}R.INITIAL_MEMORY;var P=[],L=[],F=[],x=0,B=null,N=null;function U(e){R.onAbort&&R.onAbort(e),O(e="Aborted("+e+")"),I=!0,e+=". Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw a(t),t}R.preloadedImages={},R.preloadedAudios={};function V(e){return e.startsWith("data:application/octet-stream;base64,")}if(R.locateFile){if(!V(T="playbackrate.wasm")){;t=T,T=R.locateFile?R.locateFile(t,C):C+t}}else T=new URL(i(894570),i.b).toString();function W(e){try{if(e==T&&l)return new Uint8Array(l);if(n)return n(e);throw"both async and sync fetching of the wasm failed"}catch(e){U(e)}}function G(e){for(;e.length>0;){var t=e.shift();if("function"==typeof t){t(R);continue}var i=t.func;"number"==typeof i?void 0===t.arg?(function(e){return E.get(e)})(i)():(function(e){return E.get(e)})(i)(t.arg):i(void 0===t.arg?null:t.arg)}}function Z(e){return E.get(e)}function K(e,t){E.set(e,t)}var Q={b:function(e,t,i){u.copyWithin(e,t,t+i)},a:function(e){var t=u.length;e>>>=0;if(e>2147483648)return!1;for(var i=1;i<=4;i*=2){var s,r,a=t*(1+.2/i);if(a=Math.min(a,e+100663296),function(e){try{return h.grow(e-d.byteLength+65535>>>16),k(h.buffer),1}catch(e){}}(Math.min(2147483648,(r=65536,(s=Math.max(e,a))%65536>0&&(s+=r-s%r),s))))return!0}return!1}};!function(){var e,t={a:Q};function i(e,t){var i,s=e.exports;R.asm=s,k((h=R.asm.c).buffer),E=R.asm.l,i=R.asm.d,L.unshift(i),!function(e){if(x--,R.monitorRunDependencies&&R.monitorRunDependencies(x),0==x&&(null!==B&&(clearInterval(B),B=null),N)){var t=N;N=null,t()}}(0)}function s(e){i(e.instance)}function r(e){return(l||"function"!=typeof fetch?Promise.resolve().then(function(){return W(T)}):fetch(T,{credentials:"same-origin"}).then(function(e){if(!e.ok)throw"failed to load wasm binary file at '"+T+"'";return e.arrayBuffer()}).catch(function(){return W(T)})).then(function(e){return WebAssembly.instantiate(e,t)}).then(function(e){return e}).then(e,function(e){O("failed to asynchronously prepare wasm: "+e),U(e)})}e=0,x++,R.monitorRunDependencies&&R.monitorRunDependencies(x);if(R.instantiateWasm)try{return R.instantiateWasm(t,i)}catch(e){return O("Module.instantiateWasm callback failed with error: "+e),!1}(l||"function"!=typeof WebAssembly.instantiateStreaming||V(T)||"function"!=typeof fetch?r(s):fetch(T,{credentials:"same-origin"}).then(function(e){return WebAssembly.instantiateStreaming(e,t).then(s,function(e){return O("wasm streaming compile failed: "+e),O("falling back to ArrayBuffer instantiation"),r(s)})})).catch(a)}();var $=R.___wasm_call_ctors=function(){return(R.___wasm_call_ctors=R.asm.d).apply(null,arguments)},j=R._initStream=function(){return(R._initStream=R.asm.e).apply(null,arguments)},H=R._initCallback=function(){return(R._initCallback=R.asm.f).apply(null,arguments)},z=R._writeSamples=function(){return(R._writeSamples=R.asm.g).apply(null,arguments)},Y=R._flushStream=function(){return(R._flushStream=R.asm.h).apply(null,arguments)},q=R._getStreamPitch=function(){return(R._getStreamPitch=R.asm.i).apply(null,arguments)},X=R._getStreamQuality=function(){return(R._getStreamQuality=R.asm.j).apply(null,arguments)},J=R._changePlaybackrate=function(){return(R._changePlaybackrate=R.asm.k).apply(null,arguments)},ee=R._free=function(){return(R._free=R.asm.m).apply(null,arguments)},et=R._malloc=function(){return(R._malloc=R.asm.n).apply(null,arguments)};function ei(e){if(e=e||D,x>0)return;if(!function(){if(R.preRun)for("function"==typeof R.preRun&&(R.preRun=[R.preRun]);R.preRun.length;)(function(e){P.unshift(e)})(R.preRun.shift());G(P)}(),!(x>0))R.setStatus?(R.setStatus("Running..."),setTimeout(function(){setTimeout(function(){R.setStatus("")},1),t()},1)):t();function t(){if(!y)y=!0,R.calledRun=!0,!I&&(G(L),r(R),R.onRuntimeInitialized&&R.onRuntimeInitialized(),!function(){if(R.postRun)for("function"==typeof R.postRun&&(R.postRun=[R.postRun]);R.postRun.length;)(function(e){F.unshift(e)})(R.postRun.shift());G(F)}())}}if(R.addFunction=function(e,t){if(!o&&(o=new WeakMap,!function(e,t){for(var i=0;i<e+t;i++){var s=function(e){return E.get(e)}(i);s&&o.set(s,i)}}(0,E.length)),o.has(e))return o.get(e);var i=function(){if(M.length)return M.pop();try{E.grow(1)}catch(e){if(!(e instanceof RangeError))throw e;throw"Unable to grow wasm table. Set ALLOW_TABLE_GROWTH."}return E.length-1}();try{(function(e,t){E.set(e,t)})(i,e)}catch(s){if(!(s instanceof TypeError))throw s;(function(e,t){E.set(e,t)})(i,function(e,t){if("function"==typeof WebAssembly.Function){for(var i={i:"i32",j:"i64",f:"f32",d:"f64"},s={parameters:[],results:"v"==t[0]?[]:[i[t[0]]]},r=1;r<t.length;++r)s.parameters.push(i[t[r]]);return new WebAssembly.Function(s,e)}var a=[1,0,1,96],n=t.slice(0,1),o=t.slice(1),l={i:127,j:126,f:125,d:124};a.push(o.length);for(var r=0;r<o.length;++r)a.push(l[o[r]]);"v"==n?a.push(0):a=a.concat([1,l[n]]),a[1]=a.length-2;var h=new Uint8Array([0,97,115,109,1,0,0,0].concat(a,[2,7,1,1,101,1,102,0,0,7,5,1,1,102,0,0])),d=new WebAssembly.Module(h);return new WebAssembly.Instance(d,{e:{f:e}}).exports.f}(e,t))}return o.set(e,i),i},N=function e(){!y&&ei(),!y&&(N=e)},R.run=ei,R.preInit)for("function"==typeof R.preInit&&(R.preInit=[R.preInit]);R.preInit.length>0;)R.preInit.pop()();return ei(),e.ready}),n=i("962315"),o=i("640345");class l{get ready(){return!!this._mod}async init(){return new Promise((e,t)=>{a({instantiateWasm:function(e,s){WebAssembly.instantiateStreaming(fetch(new URL(i(894570),i.b)),e).then(e=>{let{instance:t}=e;return s(t)}).catch(t)}}).then(t=>{this.logger.log("backrate module inited!"),this._mod=t,this._initProcess(),e(!0)}).catch(t)})}addFrame(e){var t,i;let s=(0,n.H$)(e);null===(t=this._inputBuffer)||void 0===t||t.set(new Uint8Array(s.data.buffer)),null===(i=this._mod)||void 0===i||i._writeSamples(this._inputPtr,s.numberOfFrames,e.timestamp)}changeRate(e){this._rate=e,this._mod&&(this._mod._changePlaybackrate(e),this.logger.log("sonic handle with rate:",e))}flush(){var e;null===(e=this._mod)||void 0===e||e._flushStream()}destroy(){var e;null===(e=this._mod)||void 0===e||e._free(this._inputPtr)}constructor(e,t,i){(0,r._)(this,"logger",new o.ZP("Rate")),(0,r._)(this,"_mod",null),(0,r._)(this,"_meta",void 0),(0,r._)(this,"_rate",1),(0,r._)(this,"_inputPtr",0),(0,r._)(this,"_inputBuffer",null),(0,r._)(this,"_port",null),(0,r._)(this,"firstAFrameOutput",0),(0,r._)(this,"heAAC",!1),(0,r._)(this,"_initProcess",()=>{let e=this._mod;if(!e)return;let t=e.addFunction(this._getProcessedAudioBuffer,"viiifi");e._initCallback(t),this._inputPtr=e._malloc(51200),this._inputBuffer=e.HEAPU8.subarray(this._inputPtr,this._inputPtr+51200),e._initStream(this._meta.outSampleRate,this._meta.outChannelCount,this._rate),this.logger.log(`sonic playback module init! rate=${this._rate}`)}),(0,r._)(this,"_getProcessedAudioBuffer",(e,t,i,s,r)=>{var a;if(!this._mod)return;let o=new DataView(this._mod.HEAPU8.subarray(e,e+t).slice().buffer),l={data:(0,n.N2)(o,i,this._meta.outChannelCount),nbSamples:i,rate:s,timestamp:r};null===(a=this._port)||void 0===a||a.postMessage({type:"frame",data:l,firstAFrameOutput:this.firstAFrameOutput,heAAC:this.heAAC},[l.data.buffer])}),this._meta=e,this._port=t,this._rate=i}}},405881:function(e,t,i){i.d(t,{Z:function(){return _}});var s=i("134761");i("675373"),i("70372");var r=i("640345"),a=i("108400"),n=i("276578"),o=i("906392");i("897860"),i("268917"),i("527785");class l{recordLoading(e){let t=parseInt(e.get("content-length")||"0"),i=e.get("Accept-Ranges"),s=e.get("Content-Range");if(!t||i||s)return;this._contentLength=t;let r=Math.floor(t/this._speed*1e3);!(r<50)&&(this._dit=performance.now(),this._startTick(t,r))}recordLoaded(){this._cleanTimer();let e=performance.now()-this._dit;this._addSample(Math.floor(this._contentLength/e))}recordChunk(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!this._timer){this._dit=performance.now(),this._startTickForStream();return}this._totalByteSize+=e,this._contentLength+=e}_startTick(e,t){this._cleanTimer(),this._timer=setInterval(()=>{let t=performance.now()-this._dit;this._addSample(Math.floor(e/t))},t)}_startTickForStream(){this._timer=setInterval(()=>{this._addSample(this._calcSampleSpeed())},3e3)}_calcSampleSpeed(){if(!this._contentLength)return this._dit=performance.now(),0;let e=performance.now()-this._dit,t=Math.floor(this._contentLength/e);return this._contentLength=0,this._dit=performance.now(),t}_addSample(e){this._recentSpeed=1e3*e,this._sampleQueue.length>3&&(this._sampleQueue=[]),this._sampleQueue.push(e),this._calcAvgSpeed(this._sampleQueue)}_calcAvgSpeed(e){let t=e.length,i=e.reduce((e,t)=>e+=t,0)/t;this._speed=1e3*Math.floor(i)}_cleanTimer(){clearTimeout(this._timer),this._timer=0}reset(){this._cleanTimer(),this._totalByteSize=0,this._sampleQueue=[]}destroy(){this._cleanTimer()}get speedInfo(){return{totalByteSize:this._totalByteSize,currentSpeed:this.avgSpeed/8e3,avgSpeed:this.avgSpeed,recentSpeed:this.recentSpeed}}get totalByteSize(){return this._totalByteSize}get avgSpeed(){return!this._speed&&this._addSample(this._calcSampleSpeed()),8*this._speed}get recentSpeed(){return!this._recentSpeed&&this._addSample(this._calcSampleSpeed()),8*this._recentSpeed}constructor(){(0,s._)(this,"_sampleQueue",[]),(0,s._)(this,"_speed",0),(0,s._)(this,"_recentSpeed",0),(0,s._)(this,"_timer",0),(0,s._)(this,"_dit",0),(0,s._)(this,"_contentLength",0),(0,s._)(this,"_totalByteSize",0),(0,s._)(this,"_speedDown",!1)}}var h=i("289493"),d=i("548548");class _ extends n.Z{initAbr(){this._abr?this._cfg.abr&&this._abr.updateConfig(this._cfg.abr):this._cfg.abr&&!this._initABRing&&(this._initABRing=!0,fetch("https://unpkg.byted-static.com/byted/webplayer-extensions/0.0.8-beta.5/dist/abr.js").then(e=>e.text()).then(e=>{Function(e)(),this._abr=new globalThis.__ABRClass(this._cfg.abr,this),this._initABRing=!1}).catch(e=>{this._initABRing=!1}))}initSR(){var e;let t=(null===(e=this.bufferSerive)||void 0===e?void 0:e._mediaCodec)||this._mediaCodec;t&&t.initSR(this._cfg.sr)}get mediaInfo(){return{}}getWritable(){return this._writeable}get cfg(){return this._cfg}setWritable(e){e.videoWritable&&(this._writeable.videoWritable=e.videoWritable),e.audioWritable&&(this._writeable.audioWritable=e.audioWritable),e.audioTrack&&(this._writeable.audioTrack=e.audioTrack)}get speedInfo(){return this._speedInfo}updateConfig(e){this._cfg=e,this.initAbr(),this.initSR()}resetWorkerInit(e){o.Z.reset(),o.Z.addWorkerInit(e)}async load(e){let{url:t,stream:i,paused:s=!0}=e;if(this._playing=s?0:1,!t)return;if(e.seamless){this.seamlessLoad(t);return}let r=o.Z.cost.workerInit;this.logger.log(`worker init cost:[${r}]`),this._loading&&o.Z.reset(),o.Z.addLoadStream(),await this._reset(),this._loadData(t,i)}seamlessLoad(e){this._seamlessSwitch=!0,this._seamlessLoadData(e)}async onSwitchCancel(){var e;await (null===(e=this._tempLoader)||void 0===e?void 0:e.cancel())}onPlay(){var e;let t=null===(e=this.mediaInfo)||void 0===e?void 0:e.firstFrameShow;this.logger.log(`on  play! firstframe:${t}`),this._playing=1}onPause(){var e,t;this._playing=0;let i=null===(e=this.mediaInfo)||void 0===e?void 0:e.firstFrameShow;this.logger.log(`on  pause! firstframe:${i}`),i&&(null===(t=this.mediaInfo)||void 0===t?void 0:t.onlyAudio)&&this._disconnect()}onError(){this.logger.log("do error handle"),this._disconnect()}onReset(){var e;this._reset(),this._cfg.url="",null===(e=this._abr)||void 0===e||e.updateConfig({open:!1})}onKeyFrame(e){this.emit(h.le.KEYFRAME,{pts:e}),this._checkAbr(e);let{currentTime:t=0,bufferEnd:i=0,firstFrameShow:s}=this.mediaInfo||{};if(i===1/0)return;let r=(i-t)/d.Ll;if(!this._playing&&s&&r>this._cfg.disconnectTime){this.logger.log(`no playing, cancel load! bufferEnd:${i/d.Ll}, currentTime:${t/d.Ll}`),this._disconnect();return}}onTimeupdate(){}onWaiting(){this._abr&&(this._abr.isStalling=!0)}_checkAbr(e){if(!this._abr||!this._abr._open||this._seamlessSwitch||Date.now()-this._seamlessSwitchTime<this._abr.config.start_limit)return;let{playbackRate:t=1,currentTime:i=0,bufferEnd:s=0}=this.mediaInfo||{},r=Math.round(Math.max(0,(s-i)/d.Ll));this._abr.checkStatus(e,this._bandwidthService.speedInfo.currentSpeed,t,r)}_checkPlaybackrate(){var e,t;let i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1800,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2500,{playbackRate:r=1,currentTime:a=0,bufferEnd:n=0}=this.mediaInfo||{},o=Math.round(1e3*Math.max(0,(n-a)/d.Ll));1.1===r?o<=i&&(null===(e=this.getMediaCodec())||void 0===e||e.onRateChange({type:d.Zo.PLAYBACKRATE,rate:1})):1===r&&o>=s&&(null===(t=this.getMediaCodec())||void 0===t||t.onRateChange({type:d.Zo.PLAYBACKRATE,rate:1.1}),this._abr&&(this._abr.isChaseFrame=!0))}async _seamlessLoadData(e){}async _disconnect(){this.logger.log("call disconnect!"),this._loading=!1,this.logger.log("load disconnected!")}async _reset(){await this._disconnect()}constructor(e,t){super(e.instanceId||"",t),(0,s._)(this,"logger",new r.ZP("RTMProtocol")),(0,s._)(this,"_tempLoader",null),(0,s._)(this,"_cfg",void 0),(0,s._)(this,"_abr",void 0),(0,s._)(this,"_bandwidthService",void 0),(0,s._)(this,"_playing",0),(0,s._)(this,"_loading",!1),(0,s._)(this,"_seamlessSwitch",!1),(0,s._)(this,"_initABRing",!1),(0,s._)(this,"_seamlessSwitchTime",Date.now()),(0,s._)(this,"_speedInfo",{speed:0,avgSpeed:0,totalByteSize:0}),(0,s._)(this,"_writeable",{videoWritable:null,audioWritable:null,audioTrack:void 0}),(0,s._)(this,"_onRetryError",(e,t)=>{var i;let s=a.Fc.network(e);this.emit(h.le.LOADRETRY,{retryTime:t,reason:s.message,error:{code:(0,h.IL)({code:s.errorCode,httpCode:null===(i=s.ext)||void 0===i?void 0:i.httpCode}),message:s.message}})}),this._cfg=e;let{writeable:i}=e;if(i){var n,o;(null===(n=i.videoWritable)||void 0===n?void 0:n.locked)&&(i.videoWritable=null),this.setWritable({videoWritable:(null===(o=i.videoWritable)||void 0===o?void 0:o.getWriter())||null,audioWritable:i.audioWritable||null,audioTrack:i.audioTrack||void 0})}this._bandwidthService=new l,this.resetWorkerInit(this._cfg.firstTimeStemp),this.initAbr(),this.initSR()}}},361234:function(e,t,i){i.d(t,{Z:function(){return v}});var s=i("134761"),r=i("520739");i("779788"),i("675373"),i("70372"),i("268917"),i("874386"),i("429532");var a=i("276578"),n=i("548548");i("981168");var o=i("640345");class l{addMeta(e){this._meta=e}get liveEdge(){return this._lastFrameTimestamp}get length(){return this._sampleQueue.length}get startGap(){return this._startGap}append(e){for(let s=0,r=e.length;s<r;s++){var t,i;let r=e[s],a=Math.floor(1e3*r.dts),n=this._lastFrameTimestamp?a-this._lastFrameTimestamp:(null===(t=this._meta)||void 0===t?void 0:t.sampleDuration)||0;-1===this._firstFrameTimestamp&&(this._firstFrameTimestamp=a,a>=this._codecConfig.audioTargetDecodeEnd&&(this._startGap=a),this.logger.log("audio first sample time:",r.dts/1e3));let o=new EncodedAudioChunk({type:"key",data:r.data,timestamp:a,duration:n<0?(null===(i=this._meta)||void 0===i?void 0:i.sampleDuration)||0:n});this._sampleQueue.push(o),this._lastFrameTimestamp=a}}rtmAppend(e){for(let t=0,i=e.length;t<i;t++){let i=e[t],s=new EncodedAudioChunk({type:"key",timestamp:Math.floor(1e3*i.dts),data:i.data.buffer});this._sampleQueue.push(s),this._sampleQueue=this._sampleQueue.sort((e,t)=>e.timestamp-t.timestamp),this._lastFrameTimestamp=this._sampleQueue[this._sampleQueue.length-1].timestamp}}get(){return this._sampleQueue[0]}shift(){return this._sampleQueue.shift()}seekTo(e){this._sampleQueue=this._sampleQueue.filter(t=>t.timestamp>=e)}removeBuffer(e,t){this._sampleQueue=this._sampleQueue.filter(t=>t.timestamp<e)}get nextFrameTimestamp(){var e;return null===(e=this._sampleQueue[0])||void 0===e?void 0:e.timestamp}constructor(e){(0,s._)(this,"logger",new o.ZP("AudioTimeRange")),(0,s._)(this,"_meta",void 0),(0,s._)(this,"_codecConfig",void 0),(0,s._)(this,"_firstFrameTimestamp",-1),(0,s._)(this,"_lastFrameTimestamp",0),(0,s._)(this,"_startGap",0),(0,s._)(this,"_sampleQueue",[]),this._codecConfig=e}}i("527785");var h=i("962315");class d{addMeta(e){this._meta=e}get liveEdge(){return this._lastFrameTimestamp}get lastGop(){return this._sampleQueue[this._sampleQueue.length-1]}get length(){return this._sampleQueue.reduce((e,t)=>e+=t.length,0)}get startGap(){return this._startGap}get nextFrameTimestamp(){var e,t;return null===(t=this._sampleQueue[0])||void 0===t?void 0:null===(e=t[0])||void 0===e?void 0:e.timestamp}get lastKeyFrame(){var e,t;return null===(t=this.lastGop)||void 0===t?void 0:null===(e=t[0])||void 0===e?void 0:e.timestamp}get nextKeyFrame(){var e,t;if((null===(t=this._sampleQueue[1])||void 0===t?void 0:null===(e=t[0])||void 0===e?void 0:e.type)==="key")return this._sampleQueue[1][0].timestamp}append(e){for(let s=0,r=e.length;s<r;s++){var t,i;let r=e[s],a=Math.floor(1e3*r.pts),n=this._lastFrameTimestamp?a-this._lastFrameTimestamp:(null===(t=this._meta)||void 0===t?void 0:t.sampleDuration)||0;if(-1===this._firstFrameTimestamp){if(!r.keyframe)continue;this._firstFrameTimestamp=a,a>=this._codecConfig.videoTargetDecodeEnd&&(this._startGap=a),this.logger.log("video first sample time:",r.dts/1e3)}let o=new EncodedVideoChunk({type:r.keyframe?"key":"delta",data:(0,h.ub)(r.units),timestamp:a,duration:n<0?(null===(i=this._meta)||void 0===i?void 0:i.sampleDuration)||0:n});o.metaIndex=r.metaIndex,this._lastFrameTimestamp=a,r.keyframe||!this.lastGop?this._sampleQueue.push([o]):this.lastGop.push(o)}}rtmAppend(e){for(let t=0,i=e.length;t<i;t++){let i=e[t],s=1e3*i.pts;if(-1===this._firstFrameTimestamp){if(!i.keyframe)continue;this._firstFrameTimestamp=s,s>=this._codecConfig.videoTargetDecodeEnd&&(this._startGap=s),this.logger.log("video first sample pts:",s/1e3)}let r=new EncodedVideoChunk({type:i.keyframe?"key":"delta",timestamp:s,data:i.units[0].buffer});this._lastFrameTimestamp=s,i.keyframe||!this.lastGop?this._sampleQueue.push([r]):this.lastGop.push(r)}}get(){var e,t;return!(null===(e=this._sampleQueue[0])||void 0===e?void 0:e[0])&&this._sampleQueue.shift(),null===(t=this._sampleQueue[0])||void 0===t?void 0:t[0]}shift(){var e,t;let i=null===(e=this._sampleQueue[0])||void 0===e?void 0:e.shift();return!i&&(this._sampleQueue.shift(),i=null===(t=this._sampleQueue[0])||void 0===t?void 0:t.shift()),i}seekTo(e){var t,i,s;let r=0;if(e<(null===(t=this.get())||void 0===t?void 0:t.timestamp))return 0;for(let t=1;t<this._sampleQueue.length;t++){if((null===(s=this._sampleQueue[t][0])||void 0===s?void 0:s.timestamp)<=e){r=t;continue}break}let a=this._sampleQueue[r],n=-1;if(!a)return 0;for(let t=0,i=a.length;t<i;t++)if(a[t].timestamp>=e){n=t;break}return r>0&&(this._sampleQueue=this._sampleQueue.slice(r)),(null===(i=a[n])||void 0===i?void 0:i.timestamp)||0}removeBuffer(e,t){let i=[];for(let t=0,s=this._sampleQueue.length;t<s&&!(this._sampleQueue[t][0].timestamp>=e);t++){;i.push(this._sampleQueue[t])}this._sampleQueue=i}constructor(e){(0,s._)(this,"logger",new o.ZP("VideoTimeRange")),(0,s._)(this,"_meta",void 0),(0,s._)(this,"_codecConfig",void 0),(0,s._)(this,"_sampleQueue",[]),(0,s._)(this,"_firstFrameTimestamp",-1),(0,s._)(this,"_startGap",0),(0,s._)(this,"_lastFrameTimestamp",0),this._codecConfig=e}}var _=i("521612"),u=i("473833"),c=i("486925"),m=i("906392"),p=i("308364");class g extends p.Z{get timestamp(){return(1e3*performance.now()|0)-this._startTimestamp}get isRunning(){return 0!==this._timer}resume(e){this.logger.log("videoTimer resume!"),this._timer&&clearInterval(this._timer),this._startTimestamp=1e3*performance.now()-e|0,this._timer=setInterval(()=>{this.emit("nextTick",this.timestamp)},15)}suspend(){if(!!this._timer)this.logger.log("suspend video timer!"),clearInterval(this._timer),this._timer=0}constructor(...e){super(...e),(0,s._)(this,"logger",new o.ZP("VideoTimer")),(0,s._)(this,"_startTimestamp",0),(0,s._)(this,"_timer",0)}}let f={canvasId:"canvas",algType:2,scaleType:0,backend:3,poolSize:2,maxWidth:1600,maxHeight:1600};class v extends a.Z{set audioMeta(e){this._audioMeta=e,this.stateManager.set("audioMeta",e)}getMediaInfo(){var e,t,i,s,r;return{onlyAudio:this._onlyAudio,onlyVideo:this._onlyVideo,currentTime:this._currentTime,VideoFrameTime:(null===(e=this._videoFrameQueue[0])||void 0===e?void 0:e.timestamp)||this._currentTime,bufferEnd:Math.min((null===(t=this._videoTimeRange)||void 0===t?void 0:t.liveEdge)||1/0,(null===(i=this._audioTimeRange)||void 0===i?void 0:i.liveEdge)||1/0),playbackRate:this._playbackRate,firstFrameShow:this._firstVFrameOutput||this._onlyAudio,lastKeyFrame:null===(s=this._videoTimeRange)||void 0===s?void 0:s.lastKeyFrame,nextKeyFrame:null===(r=this._videoTimeRange)||void 0===r?void 0:r.nextKeyFrame}}getFirstFrameCost(){return m.Z}onCurrentTime(e){var t,i,s,r;let a=null===(t=this._videoTimeRange)||void 0===t?void 0:t.seekTo(e.time*n.Ll);this._inSeeking=!0,a&&(this.logger.log(`seek to: ${a}, currentTime:${this._currentTime}`),this._currentTime=this._seekTaTimestamp=a,null===(i=this._audioTimeRange)||void 0===i||i.seekTo(a),this._decodeLoop(a),null===(s=this._videoTimer)||void 0===s||s.suspend(),null===(r=this._audioDecoder)||void 0===r||r.flush().then(()=>{var e;this._emptyAVFrames(),null===(e=this._audioWritable)||void 0===e||e.postMessage({type:"clean"})}))}onMutedSet(e){var t,i,s,r;this.logger.log("mutedset:",JSON.stringify(e)),this._autoplayPolicy=e.canAutoPlay,e.muted?(this._videoFrameQueue=this._videoFrameQueue.filter(e=>!!(e.timestamp>=this._currentTime)||(e.close(),!1)),null===(i=this._videoTimer)||void 0===i||i.resume(this._currentTime)):this._muted&&e.canAutoPlay&&(null===(t=this._videoTimer)||void 0===t?void 0:t._timer)&&(this.logger.warn("destroy videoTimer driver!"),this._autoplayPolicy=!0,null===(s=this._videoTimer)||void 0===s||s.suspend(),null===(r=this._audioTimeRange)||void 0===r||r.seekTo(this._currentTime),this._videoFrameQueue=this._videoFrameQueue.filter(e=>!!(e.timestamp>=this._currentTime)||(e.close(),!1)),this._filterAudioFrame(this._currentTime),this._decodeLoop(this._currentTime)),this._muted=e.muted}onPlay(e){this.onMutedSet(e)}onRateChange(e){var t;if("number"==typeof e.rate&&this._playbackRate!==e.rate)this.logger.log("set playback rate:",e.rate),this._playbackRate!==e.rate&&(this._playbackRate=e.rate,null===(t=this._rateModule)||void 0===t||t.changeRate(this._playbackRate))}onWritable(e){var t;this.logger.log("render init:",e,`[${performance.now()}]`),this.logger.log("autoplayPolicy:",e.autoplayPolicy,"muted:",e.muted),m.Z.addRenderInited(),this._autoplayPolicy=e.autoplayPolicy||e.canAutoPlay,e.videoWritable&&(this._videoWritable=null===(t=e.videoWritable)||void 0===t?void 0:t.getWriter()),e.audioWritable&&(this._audioWritable=e.audioWritable),e.audioTrack&&(this._audioTrack=e.audioTrack),this._bindVideoRenderDeriver(),this._endOfStream&&!this._firstVFrameOutput&&this._decodeLoop(this._currentTime)}updateLoudness(e){if(!this._volumeBalanceConfig)return;let{type:t,payload:i}=e.data;if(100===t)try{let e=new TextDecoder("utf-8").decode(i);e=e.slice(e.indexOf("{"),e.lastIndexOf("}")+1);let t=JSON.parse(e),s=t.loudness||t.audio_loudness;if(s){let{sourcePeak:e,sourceLuft:t,integrated_source_loudness:i,integrated_source_peak:r}=s,a=this._volumeBalanceConfig,n=t||i,o=e||r;void 0!==o&&(o=Number(o),!isNaN(o)&&(a.source_peak=o)),void 0!==n&&(a.source_lufs=n),!this._volumeBalance&&this._audioMeta?this.initVolumeBalance(this._audioMeta,a):this.onVolumeBalanceUpdate({param:a})}}catch(e){}}onVolumeBalanceUpdate(e){this.logger.log("set volume balance param:",e.param),this._volumeBalance?this._volumeBalance.update((0,c.Ku)(this._audioMeta,e.param)):this._volumeBalanceConfig=e.param}initVolumeBalance(e,t){let i=t||this._volumeBalanceConfig;!this._volumeBalance&&i&&!this._initVolumeBalancing&&(this._initVolumeBalancing=!0,fetch("https://unpkg.byted-static.com/byted/webplayer-extensions/0.0.11/dist/live-volumebalance.js").then(e=>e.text()).then(t=>{Function(t)(),this.logger.log("init volume balance"),this._volumeBalance=new globalThis.__LiveVolumeBalanceClass((0,c.Ku)(e,i)),this._initVolumeBalancing=!1}).catch(e=>{this._initVolumeBalancing=!1}))}onPause(){var e;null===(e=this._videoTimer)||void 0===e||e.suspend()}onError(){}async addMetaData(e,t){var i,s,r,a;this._videoMeta=e,m.Z.addMeta(),this.logger.log("get metadata:",e,t,"videoFrameRate:",null==e?void 0:e.frameRate,`[${performance.now()}]`),this._videoTargetDecodeEnd=v.codecConfig.videoTargetDecodeEnd,e&&e.frameRate<20&&(this._videoTargetDecodeEnd=2*v.codecConfig.videoTargetDecodeEnd),e?null===(i=this._videoTimeRange)||void 0===i||i.addMeta(e):this._videoTimeRange=null,t?null===(s=this._audioTimeRange)||void 0===s||s.addMeta(t):this._audioTimeRange=null,"function"==typeof WritableStreamDefaultWriter&&this._videoWritable instanceof WritableStreamDefaultWriter&&!((this._videoWritable.desiredSize||0)>0)&&(this._videoWritable=null),!!e!=!!this._videoWritable||!!t!=!!this._audioWritable||(null==t?void 0:t.sampleRate)!==(null===(r=this._audioMeta)||void 0===r?void 0:r.sampleRate)||(null==t?void 0:t.heAAC)!==(null===(a=this._audioMeta)||void 0===a?void 0:a.heAAC)?(this.emit(n.Zo.MESSAGE_INIT_RENDER,{video:!!e,audio:!!t,channelCount:null==t?void 0:t.channelCount,sampleRate:(null==t?void 0:t.sampleRate)||0,heAAC:(null==t?void 0:t.heAAC)||!1,audioTrack:this._audioTrack}),this.audioMeta=t,this._audioTrack=void 0):(m.Z.addRenderInited(),this._autoplayPolicy=!0,this._bindVideoRenderDeriver(),this._endOfStream&&!this._firstVFrameOutput&&this._decodeLoop(this._currentTime),this.audioMeta=t);let o=[];e&&o.push(this._videoDecoderInit(e).then(e=>{this._videoDecoder=e}).catch(e=>{this.emit(n.Zo.MESSAGE_EVENT_VEERROR,_.Z.create(_.t.DECODE_VIDEO_INIT_ERROR,"DECODE_VIDEO_INIT_ERROR",e))})),t&&o.push(this._audioDecoderInit(t).catch(e=>{this.emit(n.Zo.MESSAGE_EVENT_VEERROR,_.Z.create(_.t.DECODE_AUDIO_INIT_ERROR,"DECODE_AUDIO_INIT_ERROR",e))})),await Promise.all(o),this.logger.log("decoder inited!"),m.Z.addDecoderInited(),this._onlyVideo=!!e&&!t,this._onlyAudio=!!t&&!e}updateMetaData(e,t){this.logger.log("update metadata",e,t)}appendBuffer(e,t,i){var s,r,a,n,o,l;if(!e.length&&!t.length)return;!this._firstSample&&(this._firstSample=1,m.Z.addFirstSample()),i?(null===(s=this._videoTimeRange)||void 0===s||s.rtmAppend(e),null===(r=this._audioTimeRange)||void 0===r||r.rtmAppend(t)):(null===(a=this._videoTimeRange)||void 0===a||a.append(e),null===(n=this._audioTimeRange)||void 0===n||n.append(t));let h=this._videoWritable&&(!this._firstVFrameOutput||!this._videoFrameQueue.length),d=this._audioWritable&&this._autoplayPolicy&&(!this._firstAFrameOutput||!this._audioFrameQueue.length);if(!this._firstVFrameOutput||!this._firstAFrameOutput){let e=Math.max((null===(o=this._videoTimeRange)||void 0===o?void 0:o.startGap)||0,(null===(l=this._audioTimeRange)||void 0===l?void 0:l.startGap)||0);e&&(this._currentTime=e)}!this._inStall&&(h||d)&&this._decodeLoop(this._currentTime),this._inStall&&this._canPlaybackAfterStall()&&(this.logger.warn("decodeLoop boot by loader, stall = true, currentTime=",this._currentTime),this._videoTimer&&!this._audioDriverRunning&&!this._videoTimer.isRunning&&this._videoTimer.resume(this._currentTime),this._decodeLoop(this._currentTime))}removeBuffer(e,t){var i,s;this.logger.log(`remove buffer, [${e}, ${t}]`),null===(i=this._videoTimeRange)||void 0===i||i.removeBuffer(e,t),null===(s=this._audioTimeRange)||void 0===s||s.removeBuffer(e,t)}endOfStream(e){var t,i,s;this._endOfStream=1,this._emitEnded=e,this.logger.log(`endOfStream! vSamples:${null===(t=this._videoTimeRange)||void 0===t?void 0:t.length}, aSamples:${null===(i=this._audioTimeRange)||void 0===i?void 0:i.length}`),this._inStall&&(this._emptyAVFrames(),null===(s=this._audioWritable)||void 0===s||s.postMessage({type:"clean"})),!this._firstAFrameOutput&&!this._firstVFrameOutput&&this._decodeLoop(),this._inStall=!1}destroy(){var e,t,i,s,r;null===(e=this._audioWritable)||void 0===e||e.postMessage({type:"clean"}),super.destroy(),this._videoDecoder&&"closed"!==this._videoDecoder.state&&this._videoDecoder.close(),this._audioDecoder&&"closed"!==this._audioDecoder.state&&this._audioDecoder.close(),this._videoDecoder=null,this._audioDecoder=null,this._audioDecodeConfig=null,this._emptyAVFrames(),null===(t=this._videoTimer)||void 0===t||t.suspend(),null===(i=globalThis.messageChannelPort)||void 0===i||i.removeEventListener("message",this._onMessageChanelEvents),null===(s=this._rateModule)||void 0===s||s.destroy(),null===(r=this._volumeBalance)||void 0===r||r.destroy(),this._volumeBalance=null,this.logger.log("destroy mediacodec")}async _videoDecoderInit(e){let t=new VideoDecoder({output:this._onVideoDecodeOutput,error:this._onVideoDecodeError}),i={codec:e.codec};return VideoDecoder.isConfigSupported(i).then(()=>t.configure(i)).then(()=>(this.logger.log("video decoder inited!"),t))}async _audioDecoderInit(e){let t=new AudioDecoder({output:this._onAudioDecodeOutput,error:this._onAudioDecodeError}),i={codec:e.codec,sampleRate:e.sampleRate,numberOfChannels:e.channelCount};return this._heAAC=e.heAAC,AudioDecoder.isConfigSupported(i).then(()=>t.configure(i)).then(()=>{this._audioDecoder=t,this._audioDecodeConfig=i,this.logger.log("audio decoder inited!")})}_handleVideoFrame(e){var t,i;if(!this._firstVFrameOutput){this._consumeVideoFrame=!0,this._firstVFrameOutput=1,this.logger.log("first video frame decoded!",`[${performance.now()}]`),m.Z.addFirstVFrame(),this.emit(n.Zo.MESSAGE_FIRSTFRAME,m.Z.cost),m.Z.reset(),null===(t=this._videoWritable)||void 0===t||t.write(e),this.renderFrames++;return}if(this._seekTaTimestamp){if(this._seekTaTimestamp!==e.timestamp){e.close();return}this.logger.log("video decode ready when seeking"),this._seekTaTimestamp=0,this._decodeLoop(e.timestamp),null===(i=this._videoTimer)||void 0===i||i.resume(e.timestamp)}this._videoFrameQueue.push(this._preProcessFrame(e))}_handleAudioFrame(e){var t,i,s;let r;let a=this._firstAFrameOutput;!this._firstAFrameOutput&&(this._firstAFrameOutput=1,m.Z.addFirstAFrame(),this.logger.log("first audio frame decoded!",`[${performance.now()}]`)),null===(t=this._audioMeta)||void 0===t||t.updateDecodedOutput(e),this._audioFrameQueue.push(e);try{r=(0,h._7)(e,null===(s=this._audioDecodeConfig)||void 0===s?void 0:s.sampleRate)}catch(e){this.logger.error("audio data transform format error",(null==e?void 0:e.message)||e),this._emptyAVFrames(),this.emit(n.Zo.MESSAGE_EVENT_VEERROR,_.Z.create(_.t.DECODE_AUDIO_DODECODE_TRANSFORM_FORMAT_ERROR,(null==e?void 0:e.message)||e));return}if(this._volumeBalance)for(let e=0,t=r.data.length;e<t;e+=128){let t=this._volumeBalance.process(r.data.subarray(e,e+128));r.data.subarray(e,e+128).set(t)}if(!(1!==this._playbackRate&&this._playbackRateProcessor(r,a)))null===(i=this._audioWritable)||void 0===i||i.postMessage({type:"frame",data:r,firstAFrameOutput:a,heAAC:this._heAAC},[r.data.buffer])}_decodeAudioHook(e){}_bindVideoRenderDeriver(){if(this._audioWritable){this.logger.warn(`video render drived by audio worklet! but autoplayPolicy:${this._autoplayPolicy}`);let e=1;this._audioWritable.onmessage=t=>{if("audioRendered"===t.data.type){var i,s,r,a,o;let l;if(this._audioDriverRunning=!0,null===(i=this._videoTimer)||void 0===i||i.suspend(),t.data.outRate&&e!==t.data.outRate&&(e=t.data.outRate),this._autoplayPolicy=!0,!this._seekTaTimestamp){if(!this._audioFrameQueue.length){this._endOfStream?this._checkEnd():!this._inStall&&!(null===(s=this._audioTimeRange)||void 0===s?void 0:s.get())&&(this.logger.warn("no audio frame, stall! v frame count:",null===(r=this._videoFrameQueue)||void 0===r?void 0:r.length),this._emitWaiting());return}this._inSeeking&&(this._inSeeking=!1,!this._innerSeek&&(this.emit(n.Zo.MESSAGE_EVENT_SEEKED),this.emit(n.Zo.MESSAGE_EVENT_CANPLAY),this.emit(n.Zo.MESSAGE_EVENT_PLAYING)),this._innerSeek=!1),this._inStall&&(this._inStall=!1,this.emit(n.Zo.MESSAGE_EVENT_CANPLAY),this.emit(n.Zo.MESSAGE_EVENT_PLAYING)),this.isRTM?l=null===(a=this._audioFrameQueue.shift())||void 0===a?void 0:a.timestamp:(l=t.data.cTime)?this._audioFrameQueue=this._audioFrameQueue.filter(e=>e.timestamp>l):l=null===(o=this._audioFrameQueue.shift())||void 0===o?void 0:o.timestamp,this.renderChunk++,this._toRenderVideo(l),this._decodeLoop(l)}}},this._audioWritable.onmessageerror=e=>{this.emit(n.Zo.MESSAGE_EVENT_VEERROR,_.Z.create(_.t.RENDER_WORKLET_RUNTIME_ERROR,"REDNER_WORKLET_RUNTIME_ERROR",e))}}(this._onlyVideo||!this._autoplayPolicy||this._muted)&&(this.logger.warn("video render drived by timer!"),!this._videoTimer&&(this._videoTimer=new g),(this._onlyVideo||this._muted)&&this._videoTimer.resume(0),this._videoTimer.off("nextTick",this.nextTick),this._videoTimer.on("nextTick",this.nextTick))}_canPlaybackAfterStall(){let e=v.codecConfig.minSamplesForPlayback,t=!this._audioTimeRange||this._audioTimeRange.length>=e,i=!this._videoTimeRange||this._videoTimeRange.length>=e;return t&&i}_playbackRateProcessor(e,t){var i,s;if(!this._audioWritable)return!1;if(!this._rateModule&&(this._rateModule=new u.Z(this._audioMeta,this._audioWritable,this._playbackRate),null===(s=this._rateModule)||void 0===s||s.init().catch(e=>{this.logger.log("sonic module init error:",e),this._playbackRate=1})),!(null===(i=this._rateModule)||void 0===i?void 0:i.ready))return!1;try{return this._rateModule.firstAFrameOutput=t,this._rateModule.heAAC=this._heAAC,this._rateModule.addFrame(e),!0}catch(e){return this.logger.log("sonic process frame error:",e),this._playbackRate=1,!1}}initSR(e){!this._sr&&e&&e.wasmUrl&&!this._initSRing&&(this._initSRing=!0,fetch("https://unpkg.byted-static.com/byted/webplayer-extensions/0.0.8-beta.8/dist/superresolution.js").then(e=>e.text()).then(t=>{if(Function(t)(),!e.canvas){let t=new OffscreenCanvas(720,1280);t.oncontextlost=e=>{this.srStates.running=!1,this.srStates.code=1,this.srStates.message="canvas context lost"},e.canvas=t}let i=Object.assign({},e,f);this._sr=new globalThis.__WebCodecSrCore((0,r._)({},i,{onRenderCallback:e=>{let{code:t,msg:i}=e;0!==t&&(this.srStates.running=!1,this.srStates.code=t,this.srStates.message=i)},onSRCodeChanged:e=>{0!==e&&(this.srStates.running=!1,this.srStates.code=e)},onSizeChange:(t,i)=>{e.canvas&&(e.canvas.width=t,e.canvas.height=i)}})),this.srStates.running=!0,this._initSRing=!1}).catch(e=>{this._initSRing=!1}))}_preProcessFrame(e){let t;if(this._sr&&this._sr.ready&&this.srStates.running){try{let i=performance.now();t=this._sr.processFrame(e);let s=performance.now();this.logger.log("_preProcessFrame prexx time",s-i)}catch(e){null==t&&(this.srStates.running=!1,this.srStates.message=e.message)}t&&e.close()}return t||e}_sendVideoFrame(e){if(this._consumeVideoFrame=!1,!!e.format&&!!globalThis.messageChannelPort)try{let t=e.clone(),i={format:e.format,codedWidth:e.codedWidth,codedHeight:e.codedHeight,timestamp:e.timestamp};globalThis.messageChannelPort.postMessage({type:"video-frame",vframe:t,options:i},[t])}catch(e){}}onPlayerDestroy(e){var t;null===(t=this._rateModule)||void 0===t||t.destroy(),this._rateModule=null,this.transWritableComponentDown({audioWritable:this._audioWritable,audioTrack:this._audioTrack,isDestroy:e.isDestroy,id:e.id})}constructor(e="",t,i,r,a=!1){var h,u;super(e,i),h=this,(0,s._)(this,"logger",new o.ZP("MediaCodec")),(0,s._)(this,"_sr",void 0),(0,s._)(this,"_initSRing",!1),(0,s._)(this,"srStates",{running:!1,code:0,message:""}),(0,s._)(this,"_videoMeta",null),(0,s._)(this,"_audioMeta",null),(0,s._)(this,"_volumeBalance",null),(0,s._)(this,"_volumeBalanceConfig",void 0),(0,s._)(this,"_initVolumeBalancing",!1),(0,s._)(this,"_audioDriverRunning",!1),(0,s._)(this,"_videoDecoder",null),(0,s._)(this,"tempDecoders",{}),(0,s._)(this,"_audioDecoder",null),(0,s._)(this,"_audioDecodeConfig",null),(0,s._)(this,"_videoTimeRange",null),(0,s._)(this,"_audioTimeRange",null),(0,s._)(this,"_videoFrameQueue",[]),(0,s._)(this,"_audioFrameQueue",[]),(0,s._)(this,"_videoWritable",null),(0,s._)(this,"_audioWritable",void 0),(0,s._)(this,"_audioTrack",void 0),(0,s._)(this,"_videoTimer",null),(0,s._)(this,"_rateModule",null),(0,s._)(this,"_heAAC",!1),(0,s._)(this,"_emitEnded",!1),(0,s._)(this,"_playbackRate",1),(0,s._)(this,"_videoTargetDecodeEnd",0),(0,s._)(this,"_firstSample",0),(0,s._)(this,"_firstVFrameOutput",0),(0,s._)(this,"_firstAFrameOutput",0),(0,s._)(this,"_videoDecoderFlushed",0),(0,s._)(this,"_audioDecoderFlushed",0),(0,s._)(this,"_currentDecodeAudioTimestamp",0),(0,s._)(this,"_lastTimeupdateTimestamp",0),(0,s._)(this,"_currentTime",0),(0,s._)(this,"_endOfStream",0),(0,s._)(this,"_preNextTick",0),(0,s._)(this,"_autoplayPolicy",!1),(0,s._)(this,"_seekTaTimestamp",0),(0,s._)(this,"_innerSeek",!1),(0,s._)(this,"_inSeeking",!1),(0,s._)(this,"_inStall",!1),(0,s._)(this,"_onlyVideo",!1),(0,s._)(this,"_onlyAudio",!1),(0,s._)(this,"_muted",!1),(0,s._)(this,"isVod",!1),(0,s._)(this,"videoMetaIndex",void 0),(0,s._)(this,"isEnded",0),(0,s._)(this,"renderFrames",0),(0,s._)(this,"renderChunk",0),(0,s._)(this,"_decodeFrames",0),(0,s._)(this,"isRTM",!1),(0,s._)(this,"_onVideoDecodeOutput",e=>{this._handleVideoFrame(e)}),(0,s._)(this,"_onAudioDecodeOutput",e=>{this._handleAudioFrame(e)}),(0,s._)(this,"_onVideoDecodeError",e=>{this.emit(n.Zo.MESSAGE_EVENT_VEERROR,_.Z.create(_.t.DECODE_VIDEO_OUTPUT_ERROR,"DECODE_VIDEO_OUTPUT_ERROR",e))}),(0,s._)(this,"_onAudioDecodeError",e=>{this.emit(n.Zo.MESSAGE_EVENT_VEERROR,_.Z.create(_.t.DECODE_AUDIO_OUTPUT_ERROR,"DECODE_AUDIO_OUTPUT_ERROR",e))}),(0,s._)(this,"_checkReInitDecoder",()=>{}),(0,s._)(this,"_decodeLoop",async function(){var e,t,i,s,r,a,o;let l,d,u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,c=!1;if(!h._onlyVideo||h._videoDecoder){for(;!h._seekTaTimestamp&&h._autoplayPolicy&&(l=null===(e=h._audioTimeRange)||void 0===e?void 0:e.get())&&h._audioDecoder;){if(l.timestamp<=u+v.codecConfig.audioTargetDecodeEnd){try{h._decodeAudioHook(l),h._audioDecoder.decode(l),null===(a=h._audioTimeRange)||void 0===a||a.shift(),c=!0,h._currentDecodeAudioTimestamp=l.timestamp}catch(e){h.emit(n.Zo.MESSAGE_EVENT_VEERROR,_.Z.create(_.t.DECODE_AUDIO_DODECODE_ERROR,"DECODE_AUDIO_DODECODE_ERROR",e)),h._audioDecoder&&"closed"!==h._audioDecoder.state&&h._audioDecoder.close(),h._audioDecoder=null,h._audioDecodeConfig=null}continue}break}for(;(d=null===(t=h._videoTimeRange)||void 0===t?void 0:t.get())&&h._videoDecoder;){if(d.timestamp<=u+h._videoTargetDecodeEnd){try{d.metaIndex!==h.videoMetaIndex&&(h.videoMetaIndex=d.metaIndex,await h._videoDecoder.flush(),"closed"!==h._videoDecoder.state&&h._videoDecoder.close(),h._videoDecoder=h.tempDecoders[h.videoMetaIndex],delete h.tempDecoders[h.videoMetaIndex]),h._decodeFrames++,h._videoDecoder.decode(d),null===(o=h._videoTimeRange)||void 0===o||o.shift()}catch(e){h.emit(n.Zo.MESSAGE_EVENT_VEERROR,_.Z.create(_.t.DECODE_VIDEO_DODECODE_ERROR,"DECODE_VIDEO_DODECODE_ERROR",e)),h._videoDecoder&&"closed"!==h._videoDecoder.state&&h._videoDecoder.close(),h._videoDecoder=null;break}continue}break}if(h._endOfStream&&!h._videoDecoderFlushed&&!(null===(i=h._videoTimeRange)||void 0===i?void 0:i.get())&&h._videoDecoder&&(h._videoDecoderFlushed=1,h._videoDecoder.flush().then(()=>{h.logger.log("end of stream. flush videoDecoder finish!!!")}).catch(e=>{})),h._endOfStream&&!h._audioDecoderFlushed&&!(null===(s=h._audioTimeRange)||void 0===s?void 0:s.get())&&h._audioDecoder&&(h._audioDecoderFlushed=1,h._audioDecoder.flush().then(()=>{var e;h.logger.log("end of stream. flush audioDecoder finish!!!"),null===(e=h._rateModule)||void 0===e||e.flush()}).catch(e=>{})),!h._seekTaTimestamp&&!c&&!h._videoTimer&&(null===(r=h._audioTimeRange)||void 0===r?void 0:r.length)){let e=h._audioTimeRange.get();Math.abs(e.timestamp-h._currentDecodeAudioTimestamp)>v.codecConfig.audioTargetDecodeEnd&&(h.logger.warn(`audio timestamp breaked, seek to next audio sample:${null==e?void 0:e.timestamp}, delta=${(null==e?void 0:e.timestamp)-h._currentTime}`),h._innerSeek=!0,h.onCurrentTime({time:e.timestamp/n.Ll}))}}}),(0,s._)(this,"_emptyAVFrames",()=>{this._videoFrameQueue.forEach(e=>e.close()),this._videoFrameQueue=[],this._audioFrameQueue.forEach(e=>e.close()),this._audioFrameQueue=[]}),(0,s._)(this,"nextTick",e=>{if(!this._videoFrameQueue.length){var t,i;if(!this._endOfStream&&!this._inStall&&!(null===(t=this._videoTimeRange)||void 0===t?void 0:t.get())){null===(i=this._videoTimer)||void 0===i||i.suspend(),this._emitWaiting();return}}this._inSeeking&&(this._inSeeking=!1,!this._innerSeek&&(this.emit(n.Zo.MESSAGE_EVENT_SEEKED),this.emit(n.Zo.MESSAGE_EVENT_CANPLAY),this.emit(n.Zo.MESSAGE_EVENT_PLAYING)),this._innerSeek=!1),this._inStall&&(this._inStall=!1,this.emit(n.Zo.MESSAGE_EVENT_CANPLAY),this.emit(n.Zo.MESSAGE_EVENT_PLAYING)),this._toRenderVideo(e),this._decodeLoop(e),this._checkEnd(),e-this._preNextTick>2e3&&(this._filterAudioFrame(e),this._preNextTick=e)}),(0,s._)(this,"_emitWaiting",()=>{!this._inStall&&(this._inStall=!0,setTimeout(()=>{this._inStall&&this.emit(n.Zo.MESSAGE_EVENT_WAITING)},v._codecCfg.emitWaitingDelayAfterStall))}),(0,s._)(this,"_toRenderVideo",e=>{this._currentTime=e;let t=this._videoFrameQueue[0];if(!t||!this._videoWritable)return;let i=e-t.timestamp;for(i>2e5&&this.emit(n.Zo.AV_UNSYNC,{currentTime:e,gap:i});t&&!(t.timestamp>e);){;this._consumeVideoFrame&&this._sendVideoFrame(t);let e=t.timestamp;this._videoWritable.write(t),this.renderFrames++,this._videoFrameQueue.shift(),Math.abs(this._lastTimeupdateTimestamp-e)>.25*n.Ll&&(this._lastTimeupdateTimestamp=e,this.emit(n.Zo.MESSAGE_EVENT_TIMEUPDATE)),t=this._videoFrameQueue[0]}}),(0,s._)(this,"_checkEnd",()=>{var e,t,i;!this.isEnded&&this._endOfStream&&(!this._videoFrameQueue.length||!this._audioFrameQueue.length)&&(!(null===(e=this._videoTimeRange)||void 0===e?void 0:e.get())||!(null===(t=this._audioTimeRange)||void 0===t?void 0:t.get())||this._videoTimer)&&(null===(i=this._videoTimer)||void 0===i||i.suspend(),this.isEnded=1,this.logger.log("play end!!!, currentTime:",this._currentTime/n.Ll),this._emitEnded&&this.emit(n.Zo.MESSAGE_EVENT_ENDED))}),(0,s._)(this,"_filterAudioFrame",e=>{var t;this._audioFrameQueue=this._audioFrameQueue.filter(t=>!!(t.timestamp>=e)||(t.close(),!1)),null===(t=this._audioWritable)||void 0===t||t.postMessage({type:"seekTo",timestamp:e})}),(0,s._)(this,"_onMessageChanelEvents",e=>{let{data:{type:t}}=e;"consume-video-frame"===t&&(this._consumeVideoFrame=!0)}),this.logger.log(`construct new mediacodec, [${performance.now()}]`),null===(u=globalThis.messageChannelPort)||void 0===u||u.addEventListener("message",this._onMessageChanelEvents),r&&(r.videoWritable&&(this._videoWritable=r.videoWritable),r.audioWritable&&(this._audioWritable=r.audioWritable),r.audioTrack&&(this._audioTrack=r.audioTrack),this._bindVideoRenderDeriver()),this.isVod=t,this._muted=a;let c=this.stateManager.get("volumeBalance");this._audioMeta=this.stateManager.get("audioMeta"),c&&(this._volumeBalanceConfig=c),this._videoTimeRange=new d(v.codecConfig),this._audioTimeRange=new l(v.codecConfig)}}},906392:function(e,t,i){var s=i(134761);t.Z=new class e{get cost(){return this._cost}reset(){this._cost={workerInit:0,loadStream:0,ttfb:0,meta:0,firstSample:0,decoderInited:0,renderInited:0,firstAFrame:0,firstVFrame:0,firstVSample:0,firstASample:0,startDecodevideo:0,outputvideo:0,loadmeta:0,metaparse:0}}getCost(){return Math.round(performance.now()-this._startTs)}addWorkerInit(e){e&&!this._cost.workerInit&&(this._cost.workerInit=Date.now()-e),this._startTs=performance.now()}addLoadStream(){!this._cost.workerInit&&(this._startTs=performance.now()),this._cost.loadStream=this.getCost()}addTTFB(){this._cost.ttfb=this.getCost()}addMeta(){this._cost.meta=this.getCost()}addFirstSample(){this._cost.firstSample=this.getCost()}addDecoderInited(){this._cost.decoderInited=this.getCost()}addRenderInited(){this._cost.renderInited=this.getCost()}addFirstAFrame(){this._cost.firstAFrame=this.getCost()}addFirstVFrame(){this._cost.firstVFrame=this.getCost()}constructor(){(0,s._)(this,"_startTs",0),this.reset()}}},686440:function(e,t,i){i.d(t,{Z:function(){return es}});var s=i("134761"),r=i("520739"),a=i("878389");i("675373");var n=i("640345"),o=i("962315"),l=i("108400");i("112587"),i("17322"),i("560401"),i("779566"),i("69896"),i("416555"),i("404948"),i("209955");class h extends Error{constructor(e,t,i,r){super(r),(0,s._)(this,"retryCount",0),(0,s._)(this,"isTimeout",!1),(0,s._)(this,"startTime",0),(0,s._)(this,"endTime",0),(0,s._)(this,"options",{}),(0,s._)(this,"url",void 0),(0,s._)(this,"request",void 0),(0,s._)(this,"response",void 0),(0,s._)(this,"message",void 0),this.url=e,this.request=t,this.response=i,this.message=r}}i("284961"),i("826893"),i("779788"),i("455663"),i("897860"),i("927234");let d=Object.prototype.toString;function _(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function u(e,t,i,s,r,a,n,o,l,h,d){return r=null!=r?parseFloat(r):null,Number.isNaN(s=parseInt(s||"0",10))&&(s=0),{data:e,done:t,options:{range:l,vid:h,index:o,contentLength:s,age:r,startTime:a,firstByteTime:n,endTime:Date.now(),priOptions:d},response:i}}var c={TEXT:"text",JSON:"json"};class m{load(e){var t;let{url:i,stream:s,vid:r,timeout:a,responseType:n,onProgress:o,index:l,onTimeout:m,onCancel:p,range:g,transformResponse:f,request:v,params:E,method:T,headers:y,body:R,mode:S,credentials:b,cache:D,redirect:w,referrer:A,referrerPolicy:C,onProcessMinLen:O,retry:M,retryDelay:I,priOptions:k}=e;this._aborted=!1,this._onProcessMinLen=O,this._onCancel=p,this._abortController="undefined"!=typeof AbortController?new AbortController:void 0,this._running=!0,this._index=l,this._range=g||[0,0],this._vid=r||i,this._priOptions=k||{};let P={method:T,headers:y,body:R,mode:S,credentials:b,cache:D,redirect:w,referrer:A,referrerPolicy:C,signal:null===(t=this._abortController)||void 0===t?void 0:t.signal},L=!1;clearTimeout(this._timeoutTimer),this.url=i,i=function(e,t){let i;if(!e)return;if(!t)return e;let s=Object.keys(t).map(e=>{if(null!=(i=t[e]))return Array.isArray(i)?e+="[]":i=[i],i.map(t=>{var i,s;if(i=t,"[object Date]"===d.call(i))t=t.toISOString();else{;if(null!==(s=t)&&"object"==typeof s)t=JSON.stringify(t)}return`${_(e)}=${_(t)}`}).join("&")}).filter(Boolean).join("&");if(s){let t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+s}return e}(i,E);let F=function(e){if(!e||null===e[0]||void 0===e[0]||0===e[0]&&(null===e[1]||void 0===e[1]))return;let t="bytes="+e[0]+"-";return e[1]&&(t+=e[1]),t}(g);F&&(y=v?v.headers:P.headers=P.headers||(Headers?new Headers:{}),Headers&&y instanceof Headers?y.append("Range",F):y.Range=F),a&&(this._timeoutTimer=setTimeout(()=>{if(L=!0,this.cancel(),m){let e=new h(i,P,null,"timeout");e.isTimeout=!0,m(e,{index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions})}},a));let x=Date.now();return this._logger.debug("[fetch load start], index,",l,",range,",g),new Promise((t,r)=>{(s?new Promise(e=>{let t=new Response(s);Object.defineProperty(t,"url",{value:i}),e(t)}):fetch(v||i,v?void 0:P)).then(async e=>{let s;if(clearTimeout(this._timeoutTimer),this._aborted||!this._running)return;if(f&&(e=f(e,i)||e),!e.ok)throw new h(i,P,e,"bad network response");let a=Date.now();if(n===c.TEXT)s=await e.text(),this._running=!1;else if(n===c.JSON)s=await e.json(),this._running=!1;else{if(o){this.resolve=t,this.reject=r,this._loadChunk(e,o,x,a);return}s=new Uint8Array(s=await e.arrayBuffer()),this._running=!1}this._logger.debug("[fetch load end], index,",l,",range,",g),t(u(s,!0,e,e.headers.get("Content-Length"),e.headers.get("age"),x,a,l,g,this._vid,this._priOptions))}).catch(s=>{if(clearTimeout(this._timeoutTimer),!this._aborted&&"cancel"!==s||L){if(this._running=!1,this._retryCount++,this._retryCount<=M){clearTimeout(this._retryTimer),this._logger.debug("[task request setTimeout],retry",this._retryCount),this._retryTimer=setTimeout(()=>{this.load(e).then(t).catch(r)},I);return}(s=s instanceof h?s:new h(i,P,null,L?"timeout":null==s?void 0:s.message)).startTime=x,s.endTime=Date.now(),s.isTimeout=L,s.options={index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions},r(s)}})})}async cancel(){if(!this._aborted){if(this._aborted=!0,this._running=!1,this._reader){try{await this._reader.cancel()}catch(e){}this._reader=void 0}if(this._abortController){try{this._abortController.abort("cancel")}catch(e){}this._abortController=void 0}clearTimeout(this._noDataTimer),clearTimeout(this._timeoutTimer),this._onCancel&&this._onCancel({index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions})}}_loadChunk(e,t,i,s){let r,a,n;if(!e.body||!e.body.getReader){this._running=!1;let t=new h(e.url,null,e,"onProgress of bad response.body.getReader");t.options={index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions},this.reject(t);return}this._onProcessMinLen>0&&(this._cache=new Uint8Array(2097152),this._writeIdx=0);let o=this._reader=e.body.getReader(),l=async()=>{var h;let d;a=Date.now(),this._noDataTimer=setTimeout(()=>{!this._aborted&&(this.cancel(),this._running=!1),this.reject({isTimeout:!1})},3e3);try{r=await o.read(),n=Date.now()}catch(e){n=Date.now(),clearTimeout(this._noDataTimer),!this._aborted&&(this._running=!1,e.options={index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions},this.reject(e));return}clearTimeout(this._noDataTimer);let _=((null===(h=this._range)||void 0===h?void 0:h.length)>0?this._range[0]:0)+this._receivedLength;if(this._aborted){this._running=!1,t(void 0,!1,{range:[_,_],vid:this._vid,index:this._index,startTime:a,endTime:n,st:i,firstByteTime:s,priOptions:this._priOptions},e);return}let c=r.value?r.value.byteLength:0;if(this._receivedLength+=c,this._onProcessMinLen>0){if(this._writeIdx+c>=this._onProcessMinLen||r.done)(d=new Uint8Array(this._writeIdx+c)).set(this._cache.slice(0,this._writeIdx),0),c>0&&d.set(r.value,this._writeIdx),this._writeIdx=0,this._logger.debug("fetchLoader,onProgress enough,done,",r.done,",len,",d.byteLength,", writeIdx,",this._writeIdx);else if(c>0&&this._writeIdx+c<2097152)this._cache.set(r.value,this._writeIdx),this._writeIdx+=c,this._logger.debug("fetchLoader,onProgress cache,len,",c,", writeIdx,",this._writeIdx);else if(c>0){let e=new Uint8Array(this._writeIdx+c+2048);this._logger.debug("fetchLoader,onProgress extra start,size,",this._writeIdx+c+2048,", datalen,",c,", writeIdx,",this._writeIdx),e.set(this._cache.slice(0,this._writeIdx),0),c>0&&e.set(r.value,this._writeIdx),this._writeIdx+=c,delete this._cache,this._cache=e,this._logger.debug("fetchLoader,onProgress extra end,len,",c,", writeIdx,",this._writeIdx)}}else d=r.value;(d&&d.byteLength>0||r.done)&&t(d,r.done,{range:[this._range[0]+this._receivedLength-(d?d.byteLength:0),this._range[0]+this._receivedLength],vid:this._vid,index:this._index,startTime:a,endTime:n,st:i,firstByteTime:s,priOptions:this._priOptions},e),r.done?(this._running=!1,this._logger.debug("[fetchLoader onProgress end],task,",this._range,",done,",r.done),this.resolve(u(r,!0,e,e.headers.get("Content-Length"),e.headers.get("age"),i,s,this._index,this._range,this._vid,this._priOptions))):l()};l()}get receiveLen(){return this._receivedLength}get running(){return this._running}set running(e){this._running=e}static isSupported(){return"undefined"!=typeof fetch}constructor(){(0,s._)(this,"_abortController",void 0),(0,s._)(this,"_timeoutTimer",null),(0,s._)(this,"_reader",void 0),(0,s._)(this,"_aborted",!1),(0,s._)(this,"_index",-1),(0,s._)(this,"_range",[0,0]),(0,s._)(this,"_receivedLength",0),(0,s._)(this,"_running",!1),(0,s._)(this,"_logger",new n.ZP("FetchLoader")),(0,s._)(this,"_vid",""),(0,s._)(this,"_retryCount",0),(0,s._)(this,"_retryTimer",void 0),(0,s._)(this,"_onProcessMinLen",0),(0,s._)(this,"_onCancel",void 0),(0,s._)(this,"_priOptions",null),(0,s._)(this,"_cache",void 0),(0,s._)(this,"resolve",void 0),(0,s._)(this,"reject",void 0),(0,s._)(this,"_writeIdx",0),(0,s._)(this,"url",""),(0,s._)(this,"_finnalUrl",""),(0,s._)(this,"_noDataTimer",null)}}var p=i("487575"),g=i("405881"),f=i("906392");i("268917"),i("250440"),i("950331"),i("954372");let v="video",E="audio",T="metadata",y={AVC:"avc",HEVC:"hevc"},R={AAC:"aac",G711PCMA:"g7110a",G711PCMU:"g7110m"},S={LARGE_AV_SHIFT:"LARGE_AV_SHIFT",LARGE_VIDEO_GAP:"LARGE_VIDEO_GAP",LARGE_VIDEO_GAP_BETWEEN_CHUNK:"LARGE_VIDEO_GAP_BETWEEN_CHUNK",LARGE_AUDIO_GAP:"LARGE_AUDIO_GAP",AUDIO_FILLED:"AUDIO_FILLED",AUDIO_DROPPED:"AUDIO_DROPPED"};class b{reset(){this.sequenceNumber=this.width=this.height=this.fpsDen=this.fpsNum=this.duration=this.baseMediaDecodeTime=this.timescale=0,this.codec="",this.present=!1,this.pid=-1,this.pps=[],this.sps=[],this.vps=[],this.sarRatio=[],this.samples=[],this.warnings=[],this.hvcC=null}get firstDts(){return this.samples.length?this.samples[0].dts:null}get firstPts(){return this.samples.length?this.samples[0].pts:null}get samplesDuration(){if(this.samples.length>0){let e=this.samples[0],t=this.samples[this.samples.length-1];return t.dts-e.dts+t.duration}return 0}exist(){return!!/av01/.test(this.codec)||!!(this.pps.length&&this.sps.length&&this.codec)}hasSample(){return!!this.samples.length}get isEncryption(){return this.isVideoEncryption}constructor(){(0,s._)(this,"id",1),(0,s._)(this,"type",v),(0,s._)(this,"codecType",y.AVC),(0,s._)(this,"pid",-1),(0,s._)(this,"hvcC",void 0),(0,s._)(this,"codec",""),(0,s._)(this,"timescale",0),(0,s._)(this,"formatTimescale",0),(0,s._)(this,"sequenceNumber",0),(0,s._)(this,"baseMediaDecodeTime",0),(0,s._)(this,"baseDts",0),(0,s._)(this,"duration",0),(0,s._)(this,"warnings",[]),(0,s._)(this,"samples",[]),(0,s._)(this,"pps",[]),(0,s._)(this,"sps",[]),(0,s._)(this,"vps",[]),(0,s._)(this,"fpsNum",0),(0,s._)(this,"fpsDen",0),(0,s._)(this,"sarRatio",[]),(0,s._)(this,"width",0),(0,s._)(this,"height",0),(0,s._)(this,"nalUnitSize",4),(0,s._)(this,"present",!1),(0,s._)(this,"isVideoEncryption",!1),(0,s._)(this,"isAudioEncryption",!1),(0,s._)(this,"isVideo",!0),(0,s._)(this,"kid",null),(0,s._)(this,"pssh",null),(0,s._)(this,"ext",void 0)}}class D{reset(){this.sequenceNumber=0,this.timescale=0,this.sampleDuration=0,this.sampleRate=0,this.channelCount=0,this.baseMediaDecodeTime=0,this.present=!1,this.pid=-1,this.codec="",this.samples=[],this.config=[],this.warnings=[]}exist(){return!!(this.sampleRate&&this.channelCount&&this.codec&&this.codecType===R.AAC)}hasSample(){return!!this.samples.length}get isEncryption(){return this.isAudioEncryption}get firstDts(){return this.samples.length?this.samples[0].dts:null}get firstPts(){return this.samples.length?this.samples[0].pts:null}get samplesDuration(){if(this.samples.length>0){let e=this.samples[0],t=this.samples[this.samples.length-1];return t.dts-e.dts+t.duration}return 0}constructor(){(0,s._)(this,"id",2),(0,s._)(this,"type",E),(0,s._)(this,"codecType",R.AAC),(0,s._)(this,"pid",-1),(0,s._)(this,"codec",""),(0,s._)(this,"sequenceNumber",0),(0,s._)(this,"sampleDuration",0),(0,s._)(this,"timescale",0),(0,s._)(this,"formatTimescale",0),(0,s._)(this,"baseMediaDecodeTime",0),(0,s._)(this,"duration",0),(0,s._)(this,"warnings",[]),(0,s._)(this,"samples",[]),(0,s._)(this,"baseDts",0),(0,s._)(this,"sampleSize",16),(0,s._)(this,"sampleRate",0),(0,s._)(this,"channelCount",0),(0,s._)(this,"objectType",0),(0,s._)(this,"sampleRateIndex",0),(0,s._)(this,"config",[]),(0,s._)(this,"present",!1),(0,s._)(this,"isVideoEncryption",!1),(0,s._)(this,"isAudioEncryption",!1),(0,s._)(this,"kid",null),(0,s._)(this,"ext",void 0)}}class w{get cts(){return this.pts-this.dts}setToKeyframe(){this.keyframe=!0,this.flag.dependsOn=2,this.flag.isNonSyncSample=0}constructor(e,t,i,r){(0,s._)(this,"flag",{}),(0,s._)(this,"keyframe",!1),(0,s._)(this,"gopId",0),(0,s._)(this,"duration",0),(0,s._)(this,"size",0),(0,s._)(this,"units",[]),(0,s._)(this,"chromaFormat",420),this.originPts=this.pts=e,this.originDts=this.dts=t,this.metaIndex=r,i&&(this.units=i)}}class A{constructor(e,t,i,r){(0,s._)(this,"duration",1024),(0,s._)(this,"flag",{dependsOn:2,isNonSyncSample:0}),(0,s._)(this,"keyframe",!0),this.originPts=this.pts=this.dts=e,this.data=t,this.size=t.byteLength,this.sampleOffset=r,i&&(this.duration=i)}}class C{constructor(e,t){(0,s._)(this,"time",0),this.data=e,this.originPts=this.pts=t}}class O extends C{}class M extends C{}class I{exist(){return!!((this.flvScriptSamples.length||this.seiSamples.length)&&this.timescale)}reset(){this.timescale=0,this.flvScriptSamples=[],this.seiSamples=[]}hasSample(){return!!(this.flvScriptSamples.length||this.seiSamples.length)}constructor(){(0,s._)(this,"id",3),(0,s._)(this,"type",T),(0,s._)(this,"timescale",0),(0,s._)(this,"flvScriptSamples",[]),(0,s._)(this,"seiSamples",[])}}class k{get bitsAvailable(){return this._bitsAvailable}_loadWord(){let e=this._data.byteLength-this._bytesAvailable,t=Math.min(4,this._bytesAvailable);if(0===t)throw Error("No bytes available");let i=new Uint8Array(4);i.set(this._data.subarray(e,e+t)),this._word=new DataView(i.buffer).getUint32(0),this._bitsAvailable=8*t,this._bytesAvailable-=t}skipBits(e){if(this._bitsAvailable>e)this._word<<=e,this._bitsAvailable-=e;else{let t=Math.floor((e-=this._bitsAvailable)/8);e-=8*t,this._bytesAvailable-=t,this._loadWord(),this._word<<=e,this._bitsAvailable-=e}}readBits(e){if(e>32)throw Error("Cannot read more than 32 bits");let t=Math.min(this._bitsAvailable,e),i=this._word>>>32-t;return(this._bitsAvailable-=t,this._bitsAvailable>0?this._word<<=t:this._bytesAvailable>0&&this._loadWord(),(t=e-t)>0&&this._bitsAvailable)?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this._bitsAvailable;++e)if((this._word&2147483648>>>e)!=0)return this._word<<=e,this._bitsAvailable-=e,e;return this._loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}readUEG(){let e=this.skipLZ();return this.readBits(e+1)-1}readEG(){let e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBool(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}skipScalingList(e){let t=8,i=8;for(let s=0;s<e;s++)0!==i&&(i=(t+this.readEG()+256)%256),t=0===i?t:i}constructor(e){if((0,s._)(this,"_bytesAvailable",void 0),(0,s._)(this,"_bitsAvailable",0),(0,s._)(this,"_word",0),!e)throw Error("ExpGolomb data params is required");this._data=e,this._bytesAvailable=e.byteLength,this._bytesAvailable&&this._loadWord()}}class P{static decode(e){let t=[],i=0,s=e.length;for(;i<s;){if(e[i]<128){t.push(String.fromCharCode(e[i])),++i;continue}if(e[i]<192);else if(e[i]<224){if(P._checkContinuation(e,i,1)){let s=(31&e[i])<<6|63&e[i+1];if(s>=128){t.push(String.fromCharCode(65535&s)),i+=2;continue}}}else if(e[i]<240){if(P._checkContinuation(e,i,2)){let s=(15&e[i])<<12|(63&e[i+1])<<6|63&e[i+2];if(s>=2048&&(63488&s)!=55296){t.push(String.fromCharCode(65535&s)),i+=3;continue}}}else if(e[i]<248&&P._checkContinuation(e,i,3)){let s=(7&e[i])<<18|(63&e[i+1])<<12|(63&e[i+2])<<6|63&e[i+3];if(s>65536&&s<1114112){s-=65536,t.push(String.fromCharCode(s>>>10|55296)),t.push(String.fromCharCode(1023&s|56320)),i+=4;continue}}t.push(String.fromCharCode(65533)),++i}return t.join("")}static _checkContinuation(e,t,i){if(!(t+i<e.length))return!1;for(;i--;)if((192&e[++t])!=128)return!1;return!0}}var L=i("165014");function F(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(e[t]<<24>>>0)+(e[t+1]<<16)+(e[t+2]<<8)+(e[t+3]||0)}function x(e){let t=[],i=e.length;if(i<=48)return e;for(let s=0;s<i-4;)0===e[s]&&0===e[s+1]&&3===e[s+2]&&e[s+3]<=3?(t.push(s+2),s+=3):s+=1;if(t.length){let s=new Uint8Array(i-t.length),r=0;return t.map((a,n)=>{let o=t[n-1]||-1,l=e.slice(o+1,a);s.set(l,r),r+=l.length,n===t.length-1&&a+1<i&&s.set(e.slice(a+1),r)}),s}return e}class B{static parseAnnexB(e){let t=e.length,i=2,s=0;for(;null!==e[i]&&void 0!==e[i]&&1!==e[i];)i++;if((s=++i+2)>=t)return[];let r=[];for(;s<t;)switch(e[s]){case 0:if(0!==e[s-1]){s+=2;break}if(0!==e[s-2]){s++;break}i!==s-2&&r.push(e.subarray(i,s-2));do s++;while(1!==e[s]&&s<t);s=(i=s+1)+2;break;case 1:if(0!==e[s-1]||0!==e[s-2]){s+=3;break}i!==s-2&&r.push(e.subarray(i,s-2)),s=(i=s+1)+2;break;default:s+=3}return i<t&&r.push(e.subarray(i)),r}static parseAvcC(e){let t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;if(e.length<4)return;let s=e.length,r=[],a=0;for(;a+i<s;){if(t=F(e,a),3===i&&(t>>>=8),a+=i,!!t){if(a+t>s)break;r.push(e.subarray(a,a+t)),a+=t}}return r}static parseSEI(e,t){let i=e.length,s=t?2:1,r=0,a=0,n="";for(;255===e[s];)r+=255,s++;for(r+=e[s++];255===e[s];)a+=255,s++;if(a+=e[s++],5===r&&i>s+16)for(let t=0;t<16;t++)n+=e[s].toString(16),s++;return{payload:e.subarray(s,s+a),type:r,size:a,uuid:n}}static removeEPB(e){let t=e.byteLength,i=[],s=1;for(;s<t-2;)0===e[s]&&0===e[s+1]&&3===e[s+2]?(i.push(s+2),s+=2):s++;if(!i.length)return e;let r=t-i.length,a=new Uint8Array(r),n=0;for(s=0;s<r;n++,s++)n===i[0]&&(n++,i.shift()),a[s]=e[n];return a}}class N{static parseAVCDecoderConfigurationRecord(e){let t,i,s;if(e.length<7)return;let r=(3&e[4])+1,a=[],n=[],o=6,l=31&e[5];for(let s=0;s<l;s++){if(i=e[o]<<8|e[o+1],o+=2,!i)continue;let s=e.subarray(o,o+i);o+=i,a.push(s),!t&&(t=N.parseSPS(B.removeEPB(s)))}let h=e[o];o++;for(let t=0;t<h;t++)s=e[o]<<8|e[o+1],o+=2,s&&(n.push(e.subarray(o,o+s)),o+=s);return{sps:t,spsArr:a,ppsArr:n,nalUnitSize:r}}static parseSPS(e){let t,i,s,r,a;let n=new k(e);n.readUByte();let o=n.readUByte(),l=n.readUByte(),h=n.readUByte();n.skipUEG();let d=420;if(100===o||110===o||122===o||244===o||44===o||83===o||86===o||118===o||128===o||138===o||144===o){let e=n.readUEG();if(e<=3&&(d=[0,420,422,444][e]),3===e&&n.skipBits(1),n.skipUEG(),n.skipUEG(),n.skipBits(1),n.readBool()){let t=3!==e?8:12;for(let e=0;e<t;e++)n.readBool()&&(e<6?n.skipScalingList(16):n.skipScalingList(64))}}n.skipUEG();let _=n.readUEG();if(0===_)n.readUEG();else if(1===_){n.skipBits(1),n.skipUEG(),n.skipUEG();let e=n.readUEG();for(let t=0;t<e;t++)n.skipUEG()}n.skipUEG(),n.skipBits(1);let u=n.readUEG(),c=n.readUEG(),m=n.readBits(1);0===m&&n.skipBits(1),n.skipBits(1);let p=0,g=0,f=0,v=0;if(n.readBool()&&(p=n.readUEG(),g=n.readUEG(),f=n.readUEG(),v=n.readUEG()),n.readBool()){if(n.readBool())switch(n.readUByte()){case 1:t=[1,1];break;case 2:t=[12,11];break;case 3:t=[10,11];break;case 4:t=[16,11];break;case 5:t=[40,33];break;case 6:t=[24,11];break;case 7:t=[20,11];break;case 8:t=[32,11];break;case 9:t=[80,33];break;case 10:t=[18,11];break;case 11:t=[15,11];break;case 12:t=[64,33];break;case 13:t=[160,99];break;case 14:t=[4,3];break;case 15:t=[3,2];break;case 16:t=[2,1];break;case 255:t=[n.readUByte()<<8|n.readUByte(),n.readUByte()<<8|n.readUByte()]}if(n.readBool()&&n.readBool(),n.readBool()&&(n.readBits(4),n.readBool()&&n.readBits(24)),n.readBool()&&(n.readUEG(),n.readUEG()),n.readBool()){let e=n.readBits(32),t=n.readBits(32);i=n.readBool(),a=(s=t)/(r=2*e)}}return{codec:function(e){let t,i="avc1.";for(let s=0;s<3;s++)(t=e[s].toString(16)).length<2&&(t=`0${t}`),i+=t;return i}(e.subarray(1,4)),profileIdc:o,profileCompatibility:l,levelIdc:h,chromaFormat:d,width:Math.ceil((u+1)*16-2*(p+g)),height:(2-m)*(c+1)*16-(m?2:4)*(f+v),sarRatio:t,fpsNum:s,fpsDen:r,fps:a,fixedFrame:i}}}class U{static getRateIndexByRate(e){return U.FREQ.indexOf(e)}static parseADTS(e,t){let i,s;let r=e.length,a=0;for(;a+2<r&&(255!==e[a]||(246&e[a+1])!=240);){;a++}if(a>=r)return;let n=a,o=[],l=(60&e[a+2])>>>2,h=U.FREQ[l];if(!h)throw Error(`Invalid sampling index: ${l}`);let d=((192&e[a+2])>>>6)+1,_=(1&e[a+2])<<2|(192&e[a+3])>>>6,{config:u,codec:c}=U._getConfig(l,_,d),m=0,p=U.getFrameDuration(h);for(;a+7<r;){if(255!==e[a]||(246&e[a+1])!=240){a++;continue}if(!(s=(3&e[a+3])<<11|e[a+4]<<3|(224&e[a+5])>>5)||r-a<s)break;i=(1&~e[a+1])*2,o.push({pts:t+m*p,data:e.subarray(a+7+i,a+s)}),m++,a+=s}return{skip:n,remaining:a>=r?void 0:e.subarray(a),frames:o,samplingFrequencyIndex:l,sampleRate:h,objectType:d,channelCount:_,codec:c,config:u,originCodec:`mp4a.40.${d}`}}static parseAudioSpecificConfig(e){if(!e.length)return;let t=e[0]>>>3,i=(7&e[0])<<1|e[1]>>>7,s=(120&e[1])>>>3,r=U.FREQ[i];if(!r)return;let{config:a,codec:n}=U._getConfig(i,s,t);return{samplingFrequencyIndex:i,sampleRate:r,objectType:t,channelCount:s,config:a,codec:n,originCodec:`mp4a.40.${t}`}}static getFrameDuration(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9e4;return 1024*t/e}static _getConfig(e,t,i){let s,r;let a=[];return L.vU?e>=6?(s=5,r=e-3):(s=2,r=e):L.Dt?(s=2,r=e):(s=2===i||5===i?i:5,r=e,e>=6?r=e-3:1===t&&(s=2,r=e)),a[0]=s<<3,a[0]|=(14&e)>>1,a[1]=(1&e)<<7,a[1]|=t<<3,5===s&&(a[1]|=(14&r)>>1,a[2]=(1&r)<<7,a[2]|=8,a[3]=0),{config:a,codec:`mp4a.40.${s}`}}static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t||3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}(0,s._)(U,"FREQ",[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]);class V{static parseHEVCDecoderConfigurationRecord(e){let t,i,s,r,a,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.length<23)return;n=n||{};let o=(3&e[21])+1,l=[],h=[],d=[],_=23,u=e[22];for(let o=0;o<u;o++){s=63&e[_],r=e[_+1]<<8|e[_+2],_+=3;for(let o=0;o<r;o++)if(a=e[_]<<8|e[_+1],_+=2,a){switch(s){case 32:{let i=e.subarray(_,_+a);!t&&(t=V.parseVPS(B.removeEPB(i),n)),d.push(i)}break;case 33:{let t=e.subarray(_,_+a);!i&&(i=V.parseSPS(B.removeEPB(t),n)),l.push(t)}break;case 34:h.push(e.subarray(_,_+a))}_+=a}}return{hvcC:n,sps:i,spsArr:l,ppsArr:h,vpsArr:d,nalUnitSize:o}}static parseVPS(e,t){t=t||{};let i=new k(e);i.readUByte(),i.readUByte(),i.readBits(12);let s=i.readBits(3);return t.numTemporalLayers=Math.max(t.numTemporalLayers||0,s+1),i.readBits(17),V._parseProfileTierLevel(i,s,t),t}static parseSPS(e){let t,i,s,r,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};a=a||{};let n=new k(e);n.readUByte(),n.readUByte(),n.readBits(4);let o=n.readBits(3);a.numTemporalLayers=Math.max(o+1,a.numTemporalLayers||0),a.temporalIdNested=n.readBits(1),V._parseProfileTierLevel(n,o,a),n.readUEG();let l=a.chromaFormatIdc=n.readUEG(),h=420;l<=3&&(h=[0,420,422,444][l]);let d=0;3===l&&(d=n.readBits(1));let _=n.readUEG(),u=n.readUEG(),c=n.readBits(1);if(1===c&&(t=n.readUEG(),i=n.readUEG(),s=n.readUEG(),r=n.readUEG()),a.bitDepthLumaMinus8=n.readUEG(),a.bitDepthChromaMinus8=n.readUEG(),1===c){let e=(1===l||2===l)&&0===d?2:1,a=1===l&&0===d?2:1;_-=e*(i+t),u-=a*(r+s)}return{codec:"hev1.1.6.L93.B0",width:_,height:u,chromaFormat:h,hvcC:a}}static _parseProfileTierLevel(e,t,i){let s=i.generalTierFlag||0;i.generalProfileSpace=e.readBits(2),i.generalTierFlag=Math.max(e.readBits(1),s),i.generalProfileIdc=Math.max(e.readBits(5),i.generalProfileIdc||0),i.generalProfileCompatibilityFlags=e.readBits(32),i.generalConstraintIndicatorFlags=[e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8)];let r=e.readBits(8);s<i.generalTierFlag?i.generalLevelIdc=r:i.generalLevelIdc=Math.max(r,i.generalLevelIdc||0);let a=[],n=[];if(t>e.bitsAvailable)throw Error(`maxSubLayersMinus inavlid size ${t}`);for(let i=0;i<t;i++)a[i]=e.readBits(1),n[i]=e.readBits(1);t>0&&e.readBits((8-t)*2);for(let i=0;i<t;i++)0!==a[i]&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),0!==n[i]&&e.readBits(8)}}class W{fix(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=!(arguments.length>2)||void 0===arguments[2]||arguments[2];e=Math.round(1e3*e);let s=this.videoTrack,r=this.audioTrack;if((t||!i)&&(this._videoLastSample=null,this._audioNextPts=void 0,this._videoNextDts=void 0,this._audioTimestampBreak=0,this._videoTimestampBreak=0,this._lastAudioExceptionGapDot=-1/0,this._lastAudioExceptionOverlapDot=-1/0,this._lastAudioExceptionLargeGapDot=-1/0,this._lastVideoExceptionLargeGapDot=-1/0,this._lastVideoExceptionChunkFirstDtsDot=-1/0),t&&!i&&(this._baseDtsInited=!1),!this._baseDtsInited&&this._calculateBaseDts(r,s),!i&&e&&(this._audioNextPts=this._videoNextDts=e),this._baseDtsInited&&(this._videoTimestampBreak||!this.videoTrack.exist())&&(this._audioTimestampBreak||!this.audioTrack.exist())&&this._resetBaseDtsWhenStreamBreaked(),this._fixAudio(r),this._keyFrameInNextChunk=!1,this._fixVideo(s),this.metadataTrack.exist()){let e=this.metadataTrack.timescale;this.metadataTrack.seiSamples.forEach(t=>{t.pts=t.originPts-this._baseDts,t.time=t.pts/e}),this.metadataTrack.flvScriptSamples.forEach(t=>{t.pts=t.originPts-this._baseDts,t.time=Math.max(0,t.pts)/e})}s.samples.length&&(s.baseMediaDecodeTime=s.samples[0].dts),r.samples.length&&(r.baseMediaDecodeTime=r.samples[0].pts*r.timescale/1e3)}_fixVideo(e){let t;let i=e.samples;if(!i.length)return;if(i.forEach(e=>{e.dts-=this._baseDts,e.pts-=this._baseDts,e.keyframe&&(this._keyFrameInNextChunk=!0)}),e.fpsNum&&e.fpsDen)t=e.timescale*(e.fpsDen/e.fpsNum);else if(e.length>1){let s=e.samples[0];t=Math.floor((e.samples[i.length-1].dts-s.dts)/(i.length-1))}else t=this._lastVideoDuration||40;let s=i.pop();if(this._videoLastSample&&i.unshift(this._videoLastSample),this._videoLastSample=s,!i.length)return;if(void 0===this._videoNextDts){let e=i[0];this._videoNextDts=e.dts}let r=i.length,a=0,n=i[0],o=this._videoNextDts-n.dts;if(Math.abs(o)>200){if(Math.abs(n.dts-this._lastVideoExceptionChunkFirstDtsDot)>5e3){var l;this._lastVideoExceptionChunkFirstDtsDot=n.dts,e.warnings.push({type:S.LARGE_VIDEO_GAP_BETWEEN_CHUNK,nextDts:this._videoNextDts,firstSampleDts:n.dts,nextSampleDts:null===(l=i[1])||void 0===l?void 0:l.dts,sampleDuration:o})}this._videoTimestampBreak>=5?(this._videoNextDts=n.dts,this._videoTimestampBreak=0):(n.dts+=o,n.pts+=o,!this.audioTrack.exist()&&(this._videoTimestampBreak=1))}for(let n=0;n<r;n++){let o=i[n].dts,l=i[n+1];((a=n<r-1?l.dts-o:s?s.dts-o:t)>1e3||a<0)&&(this._videoTimestampBreak++,Math.abs(o-this._lastVideoExceptionLargeGapDot)>5e3&&(this._lastVideoExceptionLargeGapDot=o,e.warnings.push({type:S.LARGE_VIDEO_GAP,time:o/e.timescale,dts:o,originDts:i[n].originDts,nextDts:this._videoNextDts,sampleDuration:a,refSampleDuration:t})),a=t),i[n].duration=a,this._videoNextDts+=a,this._lastVideoDuration=a}}_fixAudio(e){let t=e.samples;t.length&&(t.forEach(e=>{e.dts=e.pts-=this._baseDts}),this._doFixAudioInternal(e,t,1e3))}_calculateBaseDts(e,t){let i=e.samples,s=t.samples;if(!i.length&&!s.length)return!1;let r=1/0,a=1/0;i.length&&(e.baseDts=r=i[0].pts),s.length&&(t.baseDts=a=s[0].dts),this._baseDts=Math.min(r,a);let n=a-r;return Number.isFinite(n)&&Math.abs(n)>500&&t.warnings.push({type:S.LARGE_AV_SHIFT,videoBaseDts:a,audioBasePts:r,baseDts:this._baseDts,delta:n}),this._baseDtsInited=!0,!0}_resetBaseDtsWhenStreamBreaked(){this._calculateBaseDts(this.audioTrack,this.videoTrack)&&(this.audioTrack.exist()?this.videoTrack.exist()?this._baseDts-=Math.min(this._audioNextPts,this._videoNextDts):this._baseDts-=this._audioNextPts:this._baseDts-=this._videoNextDts,this._videoTimestampBreak=0,this._audioTimestampBreak=0)}_doFixAudioInternal(e,t,i){!e.sampleDuration&&(e.sampleDuration=e.codecType===R.AAC?U.getFrameDuration(e.timescale,i):this._getG711Duration(e));let s=e.sampleDuration,r=e.codecType===R.AAC?1024:s*e.timescale/1e3;if(void 0===this._audioNextPts){let e=t[0];this._audioNextPts=e.pts}for(let i=0;i<t.length;i++){let a=this._audioNextPts,n=t[i],o=n.pts-a;if(0===i&&this._audioTimestampBreak>=5&&this._keyFrameInNextChunk&&(a=this._audioNextPts=n.dts,o=0,this._audioTimestampBreak=0),!this._audioTimestampBreak&&o>=3*s&&o<=1e3&&!L.G6){let l=this._getSilentFrame(e)||t[0].data.subarray(),h=Math.floor(o/s);Math.abs(n.pts-this._lastAudioExceptionGapDot)>5e3&&(this._lastAudioExceptionGapDot=n.pts,e.warnings.push({type:S.AUDIO_FILLED,pts:n.pts,originPts:n.originPts,count:h,nextPts:a,refSampleDuration:s}));for(let e=0;e<h;e++){let e=new A(Math.floor(this._audioNextPts+s)-Math.floor(this._audioNextPts),l,r);e.originPts=Math.floor(this._baseDts+a),t.splice(i,0,e),this._audioNextPts+=s,i++}i--}else o<=-3*s&&o>=-1e3?(Math.abs(n.pts-this._lastAudioExceptionOverlapDot)>5e3&&(this._lastAudioExceptionOverlapDot=n.pts,e.warnings.push({type:S.AUDIO_DROPPED,pts:n.pts,originPts:n.originPts,nextPts:a,refSampleDuration:s})),t.splice(i,1),i--):(Math.abs(o)>1e3&&(this._audioTimestampBreak++,Math.abs(n.pts-this._lastAudioExceptionLargeGapDot)>5e3&&(this._lastAudioExceptionLargeGapDot=n.pts,e.warnings.push({type:S.LARGE_AUDIO_GAP,time:n.pts/1e3,pts:n.pts,originPts:n.originPts,nextPts:a,sampleDuration:o,refSampleDuration:s}))),n.dts=n.pts=a,n.duration=r,this._audioNextPts+=s)}}_getG711Duration(e){let{sampleSize:t,channelCount:i,sampleRate:s}=e,r=e.samples[0];if(r)return 2*r.data.byteLength/i/(t/8)/s*1e3}_getSilentFrame(e){return e.codecType===R.AAC?U.getSilentFrame(e.codec,e.channelCount):new Uint8Array(8*e.sampleDuration*e.channelCount)}constructor(e,t,i){this.videoTrack=e,this.audioTrack=t,this.metadataTrack=i,this._baseDts=-1,this._baseDtsInited=!1,this._audioNextPts=void 0,this._videoNextDts=void 0,this._audioTimestampBreak=0,this._videoTimestampBreak=0,this._lastVideoDuration=0,this._keyFrameInNextChunk=!1,this._lastAudioExceptionGapDot=-1/0,this._lastAudioExceptionOverlapDot=-1/0,this._lastAudioExceptionLargeGapDot=-1/0,this._lastVideoExceptionLargeGapDot=-1/0,this._lastVideoExceptionChunkFirstDtsDot=-1/0}}class G{static parse(e){if(e.length<3)return;let t={},i=G._parseValue(new DataView(e.buffer,e.byteOffset,e.byteLength)),s=G._parseValue(new DataView(e.buffer,e.byteOffset+i.size,e.byteLength-i.size));return t[i.data]=s.data,t}static _parseValue(e){let t;let i=e.byteLength,s=e.getUint8(0),r=1,a=!1;switch(s){case 0:t=e.getFloat64(1),r+=8;break;case 1:t=!!e.getUint8(1),r+=1;break;case 2:{let{data:i,size:s}=G._parseString(new DataView(e.buffer,e.byteOffset+r,e.byteLength-r));t=i,r+=s}break;case 3:{t={};let s=0;for((16777215&e.getUint32(i-4))==9&&(s=3);r<i-4;){let{size:i,data:a,isEnd:n}=G._parseObject(new DataView(e.buffer,e.byteOffset+r,e.byteLength-r-s));if(n)break;t[a.name]=a.value,r+=i}r<=i-3&&9==(16777215&e.getUint32(r-1))&&(r+=3)}break;case 8:{t={},r+=4;let s=0;for((16777215&e.getUint32(i-4))==9&&(s=3);r<i-8;){let{size:i,data:a,isEnd:n}=G._parseObject(new DataView(e.buffer,e.byteOffset+r,e.byteLength-r-s));if(n)break;t[a.name]=a.value,r+=i}r<=i-3&&9==(16777215&e.getUint32(r-1))&&(r+=3)}break;case 9:t=void 0,r=1,a=!0;break;case 10:{t=[];let i=e.getUint32(1);r+=4;for(let s=0;s<i;s++){let{data:i,size:s}=G._parseValue(new DataView(e.buffer,e.byteOffset+r,e.byteLength-r));t.push(i),r+=s}}break;case 11:t=new Date(e.getFloat64(r)+6e4*e.getInt16(r+8)),r+=10;break;case 12:{let i=e.getUint32(1);r+=4,t="",i>0&&(t=P.decode(new Uint8Array(e.buffer,e.byteOffset+r,i))),r+=i}break;default:r=i}return{data:t,size:r,isEnd:a}}static _parseString(e){let t=e.getUint16(0),i="";return t>0&&(i=P.decode(new Uint8Array(e.buffer,e.byteOffset+2,t))),{data:i,size:2+t}}static _parseObject(e){if(e.byteLength<3)return;let t=G._parseString(e),i=G._parseValue(new DataView(e.buffer,e.byteOffset+t.size,e.byteLength-t.size));return{data:{name:t.data,value:i.data},size:t.size+i.size,isEnd:i.isEnd}}}var Z=i("943186");class K{set awManager(e){this._awManager=e}get awManager(){return this._awManager}descrypt(e){if(e.length<32)return e;let t=e.slice(16),i=t.length%16,s=t.length-i,r=this.awManager.descrypt(t.slice(0,s),new Uint8Array(16)),a=new Uint8Array(r.length+i+16);return a.set(e.slice(0,16),0),a.set(r,16),a.set(e.slice(s+16),r.length+16),a}constructor(){(0,s._)(this,"descryptVideo",e=>{if(e.length<48)return e;let t=e.slice(32),i=t.length%16;0===i&&(i=16);let s=t.length-i,r=new Uint8Array(e.length);r.set(e.slice(0,32),0);let a=new Uint8Array(16);for(let e=0;e<s;e+=160){let i=t.slice(e,e+16),s=this.awManager.descrypt(i,a);r.set(s,e+32),r.set(t.slice(e+16,e+160),e+48),a=i}return r.set(e.slice(s+32),s+32),r})}}let Q=new n.ZP("FlvDemuxer");class ${set awManager(e){this._awManager=e,this.descryptor&&(this.descryptor.awManager=e)}get awManager(){return this._awManager}demux(e){let t,i,s,r,a,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=!(arguments.length>2)||void 0===arguments[2]||arguments[2],{audioTrack:l,videoTrack:h,metadataTrack:d}=this;if((n||!o)&&(this._remainingData=null),n&&(this._headerParsed=!1),n?(h.reset(),l.reset(),d.reset()):(h.samples=[],l.samples=[],d.seiSamples=[],d.flvScriptSamples=[],h.warnings=[],l.warnings=[],this._remainingData&&(e=(0,Z.gJ)(this._remainingData,e),this._remainingData=null)),!e.length)return{videoTrack:h,audioTrack:l,metadataTrack:d};let _=0;if(!this._headerParsed){if(!$.probe(e))throw Error("Invalid flv file");l.present=(4&e[4])>>>2!=0,h.present=(1&e[4])!=0,this._headerParsed=!0,_=F(e,5)+4}let u=e.length;for(;_+15<u&&(t=e[_],i=e[_+1]<<16|e[_+2]<<8|e[_+3],!(_+15+i>u));){;s=(e[_+7]<<24>>>0)+(e[_+4]<<16)+(e[_+5]<<8)+e[_+6],_+=11,r=e.subarray(_,_+i),8===t?this._parseAudio(r,s):9===t?this._parseVideo(r,s):18===t?this._parseScript(r,s):Q.warn(`Invalid tag type: ${t}`),_+=i,(a=F(e,_))!==11+i&&Q.warn(`Invalid PrevTagSize ${a} (${11+i})`),_+=4}return _<u&&(this._remainingData=e.subarray(_)),l.formatTimescale=h.formatTimescale=h.timescale=d.timescale=1e3,l.timescale=l.sampleRate||0,!l.exist()&&l.hasSample()&&l.reset(),!h.exist()&&h.hasSample()&&h.reset(),{videoTrack:h,audioTrack:l,metadataTrack:d}}fix(e,t,i){return this._fixer.fix(e,t,i),{videoTrack:this.videoTrack,audioTrack:this.audioTrack,metadataTrack:this.metadataTrack}}demuxAndFix(e,t,i,s){this.demux(e,t,i);let r=this.isnewPlayer&&this.metaChange;return i=!r&&i,this.fix(s,t||r,i)}static probe(e){return 70===e[0]&&76===e[1]&&86===e[2]&&1===e[3]&&F(e,5)>=9}_parseAudio(e,t){if(!e.length)return;let i=(240&e[0])>>>4,s=this.audioTrack;if(10!==i&&7!==i&&8!==i){Q.warn(`Unsupported sound format: ${i}`),s.reset();return}if(10!==i){let t=(12&e[0])>>2,i=(2&e[0])>>1,r=1&e[0];s.sampleRate=$.AUDIO_RATE[t],s.sampleSize=i?16:8,s.channelCount=r+1}10===i?this._parseAac(e,t):this._parseG711(e,t,i)}_parseG711(e,t,i){let s=this.audioTrack;s.codecType=7===i?R.G711PCMA:R.G711PCMU,s.sampleRate=8e3,s.codec=s.codecType,s.samples.push(new A(t,e.subarray(1)))}_parseAac(e,t){let i=this.audioTrack;if(i.codecType=R.AAC,0===e[1]){let t=U.parseAudioSpecificConfig(e.subarray(2));t?(i.codec=t.codec,i.channelCount=t.channelCount,i.sampleRate=t.sampleRate,i.config=t.config,i.objectType=t.objectType,i.sampleRateIndex=t.samplingFrequencyIndex):(i.reset(),Q.warn("Cannot parse AudioSpecificConfig",e))}else if(1===e[1]){if(null==t)return;e=e.slice(2,e.length),e=this.descrypt(e),i.samples.push(new A(t,e))}else Q.warn(`Unknown AACPacketType: ${e[1]}`)}_parseVideo(e,t){if(e.length<6)return;let i=(240&e[0])>>>4,s=15&e[0],r=this.videoTrack;if(7!==s&&12!==s){r.reset(),Q.warn(`Unsupported codecId: ${s}`);return}let a=12===s;r.codecType=a?y.HEVC:y.AVC;let n=e[1],o=(e[2]<<16|e[3]<<8|e[4])<<8>>8;if(0===n){let t=e.subarray(5),i=r.sps.length,s=a?V.parseHEVCDecoderConfigurationRecord(t):N.parseAVCDecoderConfigurationRecord(t);if(s){let{hvcC:e,sps:t,ppsArr:a,spsArr:n,vpsArr:o,nalUnitSize:l}=s;e&&(r.hvcC=r.hvcC||e),t&&(r.codec=t.codec,r.width=t.width,r.height=t.height,r.sarRatio=t.sarRatio,r.fpsNum=t.fpsNum,r.fpsDen=t.fpsDen),n.length&&(r.sps=n),a.length&&(r.pps=a),o&&o.length&&(r.vps=o),l&&(r.nalUnitSize=l),i&&(this.metaChange=!0,this.videoMetaIndex++)}else Q.warn(`Cannot parse ${a?"HEVC":"AVC"}DecoderConfigurationRecord`,e)}else if(1===n){let s=B.parseAvcC(e.subarray(5),r.nalUnitSize);if((s=this._checkAddMetaNalToUnits(a,s,r))&&s.length){let e=[],n=!1;s.forEach(i=>{let s=a?i[0]>>>1&63:31&i[0];switch((a&&[0,1,2,3,4,5,6,7,8,9,16,17,18,19,20,21].includes(s)||!a&&[1,5].includes(s))&&(i=this.getSourceUnit(i),i=this.descryptVideo(i)),s){case 5:case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:if(e.push(i),!a&&5!==s||a&&5===s)break;n=!0;break;case 6:case 39:case 40:if(!a&&6!==s||a&&6===s){e.push(i);break}this.metadataTrack.seiSamples.push(new M(B.parseSEI(B.removeEPB(i),a),t+o));break;default:this.isnewPlayer?![7,8,32,33,34,35,38].includes(s)&&e.push(i):e.push(i)}});let l=new w(t+o,t,e,this.videoMetaIndex);(1===i||n)&&l.setToKeyframe(),r.samples.push(l),l.keyframe&&this._gopId++,l.gopId=this._gopId}else Q.warn("Cannot parse NALUs",e)}else 2===n||Q.warn(`Unknown AVCPacketType: ${n}`)}_checkAddMetaNalToUnits(e,t,i){return!e||!this._needAddMetaBeforeKeyFrameNal||t.map(e=>e[0]>>>1&63).includes(32)?(this._needAddMetaBeforeKeyFrameNal=!1,t):(t.unshift(i.pps[0]),t.unshift(i.sps[0]),t.unshift(i.vps[0]),t.filter(Boolean))}_parseScript(e,t){let{onMetaData:i}=G.parse(e)||{};this.metadataTrack.flvScriptSamples.push(new O(i,t)),i&&(i.encrypt_method&&"SAMPLE-AES"===i.encrypt_method?(this.descryptor=new K,this.descryptor.awManager=this._awManager,this.getSourceUnit=x):i.encrypt_method)}descrypt(e){return this.descryptor?this.descryptor.descrypt(e):e}constructor(e,t,i){(0,s._)(this,"_headerParsed",!1),(0,s._)(this,"_remainingData",null),(0,s._)(this,"_gopId",0),(0,s._)(this,"_needAddMetaBeforeKeyFrameNal",!0),(0,s._)(this,"isnewPlayer",!1),(0,s._)(this,"descryptVideo",e=>this.descryptor?this.descryptor.descryptVideo(e):e),this.videoTrack=e||new b,this.audioTrack=t||new D,this.metadataTrack=i||new I,this._fixer=new W(this.videoTrack,this.audioTrack,this.metadataTrack),this.getSourceUnit=e=>e,this.videoMetaIndex=0}}(0,s._)($,"AUDIO_RATE",[5500,11e3,22e3,44e3]);var j=i("648464"),H=i("361234");class z extends H.Z{set audioMeta(e){this._audioMeta=e,e&&(this._bufferService._audioMeta=e)}async _videoDecoderInit(e){let t=new VideoDecoder({output:this._onVideoDecodeOutput,error:this._onVideoDecodeError}),i={codec:e.codec,codedWidth:e.width,codedHeight:e.height,description:-1!==e.codec.indexOf("hev1")?(0,o.Af)(e):(0,o.sk)(e)};return VideoDecoder.isConfigSupported(i).then(()=>t.configure(i)).then(()=>(this.logger.log("video decoder inited!"),t))}constructor(e,t){let{instanceId:i,isVod:r,stateManager:a,writeable:n,muted:o}=t;super(i,r,a,n,o),(0,s._)(this,"_bufferService",void 0),(0,s._)(this,"videoMetaIndex",0),this._bufferService=e}}class Y{get frameRate(){return this._frameRate}get sampleDuration(){return Math.floor(1e3/this._frameRate*1e3)}constructor(e,t){(0,s._)(this,"codec",""),(0,s._)(this,"width",0),(0,s._)(this,"height",0),(0,s._)(this,"timescale",0),(0,s._)(this,"vps",[]),(0,s._)(this,"sps",[]),(0,s._)(this,"pps",[]),(0,s._)(this,"hvcC",null),(0,s._)(this,"_frameRate",25),this.codec=e.codec,this.width=e.width,this.height=e.height,this.timescale=e.timescale,this.vps=e.vps,this.pps=e.pps,this.sps=e.sps,this.hvcC=e.hvcC,t&&(t.flvScriptSamples.forEach(e=>{var t,i,s,r;(null===(i=e.data)||void 0===i?void 0:null===(t=i.onMetaData)||void 0===t?void 0:t.framerate)&&(this._frameRate=null===(r=e.data)||void 0===r?void 0:null===(s=r.onMetaData)||void 0===s?void 0:s.framerate)}),!this._frameRate&&e.fpsNum&&(this._frameRate=e.fpsNum/e.fpsDen))}}class q{get heAAC(){return 2!==this.objectType||22050===this.sampleRate||24e3===this.sampleRate}get sampleDuration(){return Math.floor(1024/this.sampleRate*1e6)}updateDecodedOutput(e){!this.outSampleRate&&(this.outSampleRate=e.sampleRate,this.outNbOfSamples=e.numberOfFrames,this.outChannelCount=e.numberOfChannels,this.logger.log(`AudioData output: ar:${this.outSampleRate}, ac:${this.outChannelCount}, samplesPreFrame:${this.outNbOfSamples}`))}constructor(e){(0,s._)(this,"logger",new n.ZP("AudioMeta")),(0,s._)(this,"codec",""),(0,s._)(this,"sampleRate",0),(0,s._)(this,"channelCount",0),(0,s._)(this,"objectType",0),(0,s._)(this,"timescale",0),(0,s._)(this,"outSampleRate",0),(0,s._)(this,"outNbOfSamples",0),(0,s._)(this,"outChannelCount",0),(0,s._)(this,"config",[]),this.codec=e.codec,this.sampleRate=e.sampleRate,this.channelCount=e.channelCount,this.objectType=e.objectType,this.timescale=e.timescale,this.config=e.config}}var X=i("289493"),J=i("548548");i("874386");class ee{addSample(e){this._seiSet.add(e)}throw(e){if(!e||!this._seiSet.size)return;let t=e-.2,i=e+.2,s=[];this._seiSet.forEach(e=>{e.time>=t&&e.time<=i&&s.push(e)}),s.forEach(e=>{this._seiSet.delete(e);let t={code:e.data.type,content:e.data.payload,dts:e.originPts,time:e.time};5===t.code&&(t.uuid=e.data.uuid),this._core.emit(X.le.SEI,t)}),this._seiSet.forEach(t=>{t.time<e-5&&this._seiSet.delete(t)})}reset(){this._seiSet.clear()}constructor(e){(0,s._)(this,"_core",void 0),(0,s._)(this,"_seiSet",new Set),this._core=e}}let et=20*J.Ll;class ei{get renderFrames(){var e;return(null===(e=this._mediaCodec)||void 0===e?void 0:e.renderFrames)||0}getMediaInfo(){var e;return null===(e=this._mediaCodec)||void 0===e?void 0:e.getMediaInfo()}updateConfig(e){this._opts=e,this._mediaCodec&&(this._mediaCodec.isVod=this._opts.isVod)}async appendBuffer(e){var t,i,s;if(!e)return;if(this._genCodecIns(),!this._demuxer&&(this._demuxer=new $,this._demuxer.isnewPlayer=!0,this._demuxer.awManager=this._opts.awManager),this._cachedBuffer&&(e=(0,Z.gJ)(this._cachedBuffer,e),this._cachedBuffer=null),this._opts.awManager&&!this._opts.awManager.inited){this._cachedBuffer=e;return}try{this._demuxer.demuxAndFix(e,this._discontinuity)}catch(t){let e=new j.Fc(j.wb.DEMUX,j.wb.SUB_TYPES.FLV,t,null,"");this._flv.emit(X.le.FLVERROR,{errorType:e.errorType,code:e.errorCode,message:e.message}),this._flv._disconnect();return}let{videoTrack:r,audioTrack:a,metadataTrack:n,metaChange:o,videoMetaIndex:l}=this._demuxer,h=r.exist(),d=a.exist();if(h&&this._opts.onlyVideo&&(d=!1,a.present=!1),r.present&&!h||a.present&&!d){let t=0,i=h?r:d?a:void 0;if(i&&i.samples.length&&(t=(i.samples[i.samples.length-1].originPts-i.samples[0].originPts)/i.timescale*1e3),t>this._opts.analyzeDuration)r.present=h,a.present=d,this.logger.warn(`analyze duration exceeded, ${t}ms, v:${h}, a:${d}`);else{this._cachedBuffer=e;return}}let _=`${r.codec}/${r.width}/${r.height}/${a.codec}/${a.config}`;if(_!==this._metaId&&(this._metaId=_,this.logger.log(_),this._emitMetaParsedEvent(r,a)),!this._metadataReady){this._metadataReady=!0;let e=null,i=null;h&&(e=new Y(r,n)),d&&(i=new q(a),this._lastAudioMeta=i),null===(t=this._mediaCodec)||void 0===t||t.addMetaData(e,i)}if(o&&(this._mediaCodec&&await this._mediaCodec._videoDecoderInit(new Y(r,n)).then(e=>{this._mediaCodec&&(this._mediaCodec.tempDecoders[l]=e)}),this._demuxer.metaChange=!1),this._seamlessSwitchTimestamp){let t=(null===(i=this.getMediaInfo())||void 0===i?void 0:i.currentTime)||0;if(this._seamlessSwitchTimestamp-t<2e5)this.logger.log(`currentTime:${t/J.Ll}s to switch position:${(this._seamlessSwitchTimestamp-t)/J.Ll}s`),this._switchBufferSeamless(r,a,n);else{this._cachedBuffer=e;return}}else try{null===(s=this._mediaCodec)||void 0===s||s.appendBuffer(r.samples,a.samples)}catch(e){throw new j.Fc(j.wb.DEMUX,j.wb.SUB_TYPES.FLV,e,null,"")}this._discontinuity=!1,this._fireEvents(r,a,n)}_switchBufferSeamless(e,t,i){let s=e.samples[0],r=s&&1e3*s.dts-this._seamlessSwitchTimestamp<-et,a=e.samples.filter(e=>e.keyframe).map(e=>1e3*e.dts),n=a.filter(e=>e<=this._seamlessSwitchTimestamp);this.logger.log(`new stream keys: ${a}`);let o=n[n.length-1]||this._seamlessSwitchTimestamp,l=e.samples.filter(e=>1e3*e.dts>=o),h=t.samples.filter(e=>1e3*e.dts>=o),d=a.filter(e=>e>this._seamlessSwitchTimestamp)[0];if(this.logger.log(`target switch point: ${this._seamlessSwitchTimestamp}, real switch point:${o}, next keyframe:${d}`),l.length||!e.exist()&&h.length||r){var _,u,c;null===(_=this._mediaCodec)||void 0===_||_.destroy(),this._mediaCodec=null,this._mediaCodec=this._genCodecIns();let s=null,r=null;e.exist()&&(s=new Y(e,i)),t.exist()&&(r=new q(t)),null===(u=this._mediaCodec)||void 0===u||u.addMetaData(s,r),e.samples=l,t.samples=h,this._seamlessSwitchTimestamp=0;try{null===(c=this._mediaCodec)||void 0===c||c.appendBuffer(e.samples,t.samples)}catch(e){throw new j.Fc(j.wb.DEMUX,j.wb.SUB_TYPES.FLV,e,null,"")}}}endOfStream(e){var t;null===(t=this._mediaCodec)||void 0===t||t.endOfStream(e)}get lastAudioMeta(){return this._lastAudioMeta}set lastAudioMeta(e){this._lastAudioMeta=e}seek(e){var t;null===(t=this._mediaCodec)||void 0===t||t.onCurrentTime({time:e})}reset(e){var t,i,s;if(this.logger.log("reset bufferservice!"),this._seiService.reset(),this._discontinuity=!0,this._firstSEIEmited=!1,!e){null===(i=this._mediaCodec)||void 0===i||i.destroy(),this._demuxer=null,this._mediaCodec=null,this._metadataReady=!1,this._cachedBuffer=null,this._seamlessSwitchTimestamp=0;return}let r=this.getMediaInfo(),a=(null==r?void 0:r.lastKeyFrame)||(null==r?void 0:r.bufferEnd)||0;a=(a-((null==r?void 0:r.currentTime)||0))/J.Ll<1&&(null==r?void 0:r.bufferEnd)||a,this._seamlessSwitchTimestamp=a,null===(t=this._mediaCodec)||void 0===t||t.removeBuffer(a),!a&&(null===(s=this._mediaCodec)||void 0===s||s.destroy(),this._mediaCodec=null,this._metadataReady=!1,this._seamlessSwitchTimestamp=0)}_genCodecIns(){return!this._mediaCodec&&(this._mediaCodec=new z(this,{instanceId:this._opts.instanceId||"",isVod:this._opts.isVod,stateManager:this._flv.stateManager,writeable:this._flv._writeable,muted:this._opts.muted}),this._mediaCodec._audioMeta=this._audioMeta,this._bindMediaCodecEvent(),this._mediaCodec.initSR(this._opts.sr)),this._mediaCodec}_bindMediaCodecEvent(){this._mediaCodec&&(this._mediaCodec.on(J.Zo.MESSAGE_EVENT_TIMEUPDATE,()=>{var e,t;this._seiService.throw(((null===(e=this.getMediaInfo())||void 0===e?void 0:e.VideoFrameTime)||0)/J.Ll),null===(t=this._flv)||void 0===t||t.onTimeupdate()}),this._mediaCodec.on(J.Zo.MESSAGE_EVENT_WAITING,()=>{var e;null===(e=this._flv)||void 0===e||e.onWaiting()}))}_emitMetaParsedEvent(e,t){e.exist()&&(this.logger.log("videoTrack:",e),this._flv.emit(X.le.METADATA,{trackType:"video",codec:e.codec,codecHeight:e.width,codecWidth:e.height,presentWidth:e.width,presentHeight:e.height,sarRatio:e.sarRatio})),t.exist()&&(this.logger.log("audioTrack:",t),this._flv.emit(X.le.METADATA,{trackType:"audio",codec:t.codec,sampleRate:t.sampleRate,objectType:t.objectType,channelCount:t.channelCount,config:t.config,refSampleDuration:t.sampleDuration}))}_fireEvents(e,t,i){if(e.samples.forEach(e=>{e.keyframe&&this._flv.onKeyFrame(e.originPts)}),!e.exist()){let{samples:e}=t;e.length&&this._flv.emit(X.le.KEYFRAME,{pts:e[e.length-1].originPts})}i.seiSamples.forEach(e=>{var t;if(e.data.size<10)return;if(null===(t=this._mediaCodec)||void 0===t||t.updateLoudness(e),this._opts.seiOnDemand&&this._firstSEIEmited){this._seiService.addSample(e);return}this._firstSEIEmited=!0;let i={code:e.data.type,content:e.data.payload,dts:e.originPts,time:e.time};5===i.code&&(i.uuid=e.data.uuid),this._flv.emit(X.le.SEI,i)})}constructor(e,t){(0,s._)(this,"logger",new n.ZP("BufferService")),(0,s._)(this,"_flv",void 0),(0,s._)(this,"_opts",void 0),(0,s._)(this,"_demuxer",null),(0,s._)(this,"_mediaCodec",null),(0,s._)(this,"_cachedBuffer",null),(0,s._)(this,"_audioMeta",null),(0,s._)(this,"_seiService",void 0),(0,s._)(this,"_discontinuity",!0),(0,s._)(this,"_metadataReady",!1),(0,s._)(this,"_seamlessSwitchTimestamp",0),(0,s._)(this,"_metaId",""),(0,s._)(this,"_firstSEIEmited",!1),(0,s._)(this,"_lastAudioMeta",null),this._flv=e,this._opts=t,this._seiService=new ee(e)}}class es extends g.Z{get mediaInfo(){return this.bufferSerive.getMediaInfo()}get lastAudioMeta(){return this.bufferSerive.lastAudioMeta}getMediaCodec(){return this.bufferSerive._mediaCodec}getWritable(){return this.bufferSerive._mediaCodec?{videoWritable:this.bufferSerive._mediaCodec._videoWritable,audioWritable:this.bufferSerive._mediaCodec._audioWritable,audioTrack:this.bufferSerive._mediaCodec._audioTrack||void 0}:this._writeable}setWritable(e){e.videoWritable&&(this._writeable.videoWritable=e.videoWritable),e.audioWritable&&(this._writeable.audioWritable=e.audioWritable),e.audioTrack&&(this._writeable.audioTrack=e.audioTrack)}set lastAudioMeta(e){this.bufferSerive.lastAudioMeta=e}updateConfig(e){super.updateConfig(e),this.bufferSerive.updateConfig(e)}onPlay(){super.onPlay(),!this._loading&&this.load({url:this._cfg.url,paused:!1})}onKeyFrame(e){super.onKeyFrame(e);let{currentTime:t=0,bufferEnd:i=0,firstFrameShow:s}=this.mediaInfo||{};if(i===1/0)return;let r=(i-t)/J.Ll;s&&r>2*this._cfg.preloadTime&&t/J.Ll>this._chaseFrameStart+this._cfg.chaseFrameStart&&(this.logger.log(`charse frame, bufferEnd: ${i/J.Ll}, currentTime:${t/J.Ll}`),this.emit(J.Zo.MESSAGE_EVENT_SEEKING),this.emit(X.le.CHASE_FRAME,{bufferEnd:i/J.Ll,preloadTime:this._cfg.preloadTime}),this.bufferSerive.seek(i/J.Ll-this._cfg.preloadTime))}onTimeupdate(){let e=Date.now();if(!(e-this._checkPlaybackrateTime<1e3))this._checkPlaybackrateTime=e,this._checkPlaybackrate(),!(e-this._speedTime<5e3)&&(this._speedTime=e,this.emit(X.le.PROP_SPEED,(0,r._)({renderFrames:this.bufferSerive.renderFrames},this._bandwidthService.speedInfo)))}async _loadData(e,t){this._cfg.url=e,!this._mediaLoader&&(this._mediaLoader=new m);try{this.logger.log(`load stream: [${performance.now()}], ${e}`),this._loading=!0,await this._mediaLoader.load((0,a._)((0,r._)({url:e,stream:t},this._cfg.fetchOptions),{retry:this._cfg.retryCount,retryDelay:this._cfg.retryDelay,timeout:this._cfg.loadTimeout,onProgress:this._onProgress,responseType:p.UN.ARRAY_BUFFER}))}catch(s){var i;this._loading=!1,this._disconnect();let t=l.Fc.network(s);this.emit(X.le.FLVERROR,{errorType:t.errorType,code:t.errorCode,message:t.message,httpCode:null===(i=t.ext)||void 0===i?void 0:i.httpCode,url:e})}}async _seamlessLoadData(e){var t,i;this._loading&&f.Z.reset(),f.Z.addLoadStream();let s=new m;await (null===(t=this._tempLoader)||void 0===t?void 0:t.cancel()),this._tempLoader=s;try{this.logger.log("seamless switch start load!"),this.emit(X.le.SWITCH_START,{url:e}),await s.load((0,a._)((0,r._)({url:e},this._cfg.fetchOptions),{retry:this._cfg.retryCount,retryDelay:this._cfg.retryDelay,timeout:this._cfg.loadTimeout,onProgress:this._onProgress,responseType:p.UN.ARRAY_BUFFER}))}catch(s){this.logger.log("seamless switch load error!");let t=l.Fc.network(s);this.emit(X.le.SWITCH_ERROR,{errorType:t.errorType,code:t.errorCode,message:t.message,httpCode:null===(i=t.ext)||void 0===i?void 0:i.httpCode,url:e}),this._seamlessSwitch=!1}}async _disconnect(e){var t,i;super._disconnect(),this.bufferSerive.endOfStream(e),this._chaseFrameStart=0,this._emitTTFB=!1,this._bandwidthService.reset(),await (null===(t=this._mediaLoader)||void 0===t?void 0:t.cancel()),await (null===(i=this._tempLoader)||void 0===i?void 0:i.cancel()),clearTimeout(this._maxChunkWaitTimer)}async _reset(){this._mediaLoader&&(await this._disconnect(),this.bufferSerive.reset(),this._seamlessSwitch=!1,this._speedTime=0,this._checkPlaybackrateTime=0)}onPlayerDestroy(e){if(e.isDestroy){var t,i;null===(t=this._mediaLoader)||void 0===t||t.cancel(),null===(i=this._tempLoader)||void 0===i||i.cancel(),this.lastAudioMeta=null}}constructor(e,t){super(e,t),(0,s._)(this,"logger",new n.ZP("FlvProtocol")),(0,s._)(this,"_mediaLoader",null),(0,s._)(this,"bufferSerive",void 0),(0,s._)(this,"_loaderResUrl",""),(0,s._)(this,"_emitTTFB",!1),(0,s._)(this,"_chaseFrameStart",0),(0,s._)(this,"_seamlessSwitchTime",Date.now()),(0,s._)(this,"_speedTime",0),(0,s._)(this,"_checkPlaybackrateTime",0),(0,s._)(this,"_maxChunkWaitTimer",0),(0,s._)(this,"_onRetryError",(e,t)=>{var i;let s=l.Fc.network(e);this.emit(X.le.LOADRETRY,{retryTime:t,reason:s.message,error:{code:(0,X.IL)({code:s.errorCode,httpCode:null===(i=s.ext)||void 0===i?void 0:i.httpCode}),message:s.message}})}),(0,s._)(this,"_onProgress",(e,t,i,s)=>{var r,a,n,l,h,d,_,u,c;let{startTime:m,endTime:p,st:g,firstByteTime:v}=i;if(this._seamlessSwitch&&this._loaderResUrl!==(null==s?void 0:s.url)&&(this.logger.log("seamless switch response ok!, currentTime:",((null===(r=this.mediaInfo)||void 0===r?void 0:r.currentTime)||0)/J.Ll,",nextKeyFrame",((null===(a=this.mediaInfo)||void 0===a?void 0:a.nextKeyFrame)||0)/J.Ll,",lastKeyFrame",((null===(n=this.mediaInfo)||void 0===n?void 0:n.lastKeyFrame)||0)/J.Ll,",bufferEnd",((null===(l=this.mediaInfo)||void 0===l?void 0:l.bufferEnd)||0)/J.Ll),this._seamlessSwitch=!1,this._emitTTFB=!1,this._cfg.url=null===(h=this._tempLoader)||void 0===h?void 0:h.url,this._chaseFrameStart=((null===(d=this.mediaInfo)||void 0===d?void 0:d.currentTime)||0)/J.Ll,this.bufferSerive.reset(!0),this._seamlessSwitchTime=Date.now(),this.emit(X.le.SWITCH_COMPLETE,{url:this._cfg.url}),null===(_=this._mediaLoader)||void 0===_||_.cancel().then(()=>{this.logger.log("cancel the old stream loaded"),this._mediaLoader=this._tempLoader,this._tempLoader=null,this._loading=!0,this._bandwidthService.reset()})),t){this.logger.warn("fetch done"),this.emit(X.le.PROP_ENDEDSTATUS,{status:J.QL.DONE,currentTime:((null===(u=this.mediaInfo)||void 0===u?void 0:u.currentTime)||0)/J.Ll,bufferEnd:((null===(c=this.mediaInfo)||void 0===c?void 0:c.bufferEnd)||0)/J.Ll}),this._disconnect(!0);return}s&&!this._emitTTFB&&e&&(f.Z.addTTFB(),this._loaderResUrl=s.url,this.logger.log(`ttfb: [${performance.now()}]`),this._emitTTFB=!0,this._seamlessSwitchTime=Date.now(),this.emit(X.le.RESPONSEHEADERS,{headers:(0,o.u8)(s.headers)}),this.emit(X.le.TTFB,{url:this._cfg.url,responseUrl:s.url,ok:s.ok,elapsed:g?v-g:p-m})),this._bandwidthService.recordChunk(null==e?void 0:e.byteLength);try{this.bufferSerive.appendBuffer(e)}catch(e){this.emit(X.le.FLVERROR,{errorType:e.errorType,code:e.errorCode,message:e.message,url:this._cfg.url}),this._disconnect()}let{maxReaderInterval:E}=this._cfg;E&&(clearTimeout(this._maxChunkWaitTimer),this._maxChunkWaitTimer=setTimeout(()=>{var e,t;this.logger.warn(`${E} ms no data receive! cancel load`),this.emit(X.le.PROP_ENDEDSTATUS,{status:J.QL.NOBUFFER,currentTime:((null===(e=this.mediaInfo)||void 0===e?void 0:e.currentTime)||0)/J.Ll,bufferEnd:((null===(t=this.mediaInfo)||void 0===t?void 0:t.bufferEnd)||0)/J.Ll}),this._disconnect(!0)},E))}),this.bufferSerive=new ei(this,this._cfg)}}},289493:function(e,t,i){i.d(t,{IL:function(){return l},le:function(){return o}});var s=i(520739),r=i(878389),a=i(648464),n=i(754448);let o=(0,r._)((0,s._)({},n.o),{FLVERROR:"error"});function l(e){return e.httpCode?e.httpCode:e.code===a.WE[a.wb.NETWORK]?21:e.code===a.WE[a.wb.NETWORK_TIMEOUT]?999:e.code===a.WE[a.wb.DEMUX].FLV?31:0}},486925:function(e,t,i){i.d(t,{AF:function(){return o},FW:function(){return n},Ku:function(){return l}});var s=i(520739);i(429532);var r=i(475566),a=i(304356);function n(e){let t=Object.assign({},o(),null==e?void 0:e.veConfig);return(0,r.R)({loaderConfig:{retryConfig:{retryCount:2,retryDelay:1e3,noRetryList:(null==e?void 0:e.protocol)===a.b.MP4?["Failed to fetch",/^(4\d{2}|5\d{2})$/gi,"timeout"]:void 0},timeout:3e3},veConfig:t,mediaInfo:{audioSampleRate:0,audioChannelCnt:0},preloadTime:5,startTime:0,seiOnDemand:!0,seamlesslyReload:!0,chaseFrameStart:0,analyzeDuration:2e3,disconnectTime:0,onlyVideo:!1,isVod:!1,protocol:a.b.FLV,removeBufferLen:60,removeBufferAtSeek:!1,resumePlayWaterLevel:2,waitJampBufferMaxCnt:1,waitingInBufferTimeOut:3e3,waitingTimeOut:5e3,closeDowngrade:!1,notDegradeErrorList:[404,403,"timeout"],h265Degrade:!1,forceVideoPlay:!1,rangeMaxDuration:15,defaultMetaSize:819200,maxBufferLength:15,tickInSeconds:.2,internalRetryCnt:1,retryCount:3,retryDelay:1e3,loadTimeout:1e4,maxReaderInterval:5e3,checkStuckTimeStepSec:1,videoDecodeTimeout:1e3},e)}function o(){return{videoDecodePreference:"hardware",audioTargetDecodeEnd:6e5,videoTargetDecodeEnd:6e5,minSamplesForPlayback:10,emitWaitingDelayAfterStall:50,cacheDuration:6e4,firstFrameResetCheck:!1}}function l(e,t){return(0,s._)({sampleRate:e.sampleRate,numChannels:e.channelCount,source_peak:.99,source_lufs:-12,target_lufs:-12,debugger:!1,duration:0,maxCount:Math.floor(e.sampleRate/128)},t)}},754448:function(e,t,i){i.d(t,{o:function(){return s}});let s={ERROR:"error",KEYFRAME:"keyframe",CHASE_FRAME:"chase_frame",LOADRETRY:"retry",TTFB:"ttfb",RESPONSEHEADERS:"responseheaders",METADATA:"metadataparsed",SEI:"SEI_PARSED",STREAM_DISCONTINUE:"streamdiscontinue",SWITCH_START:"switch_start",SWITCH_COMPLETE:"switch_completed",SWITCH_ERROR:"switch_error",PROP_SPEED:"flv_prop_speed",PROP_ENDEDSTATUS:"flv_prop_endedstatus",CHANGE_URL:"change_url",DELETE_PCDN_URL:"delete_pcdn_url",CHANGE_BITRATE_SUCCESS:"change_bitrate_success",WAITING_TIMEOUT:"waiting_timeout",RTM_NETWORK:"rtm_network"}},304356:function(e,t,i){i.d(t,{b:function(){return s}});var s={FLV:"flv",MP4:"mp4",MP3:"mp3",DASH:"dash",RTM:"rtm"}},522544:function(e,t,i){i.d(t,{Z:function(){return n}});var s=i(134761),r=i(520739);i(874386);let a={autoplayPolicy:null,muted:null,playbackRate:1,rateChanged:!1,paused:null,firstVFrameOutput:!1,firstAFrameOutput:!1,loop:!1,volumeBalance:null,error:null,visibilityState:!0};class n{getAllStates(){return this.state}get(e){return this.state[e]}set(e,t){this.state[e]!==t&&(this.state[e]=t,this.listeners.forEach(e=>e({data:this.state})),this.propListeners.has(e)&&this.propListeners.get(e).forEach(e=>e(t)))}resetStates(){this.state=(0,r._)({},a)}subscribe(e){this.listeners.add(e)}unsubscribe(e){this.listeners.delete(e)}subscribeToProp(e,t){!this.propListeners.has(e)&&this.propListeners.set(e,new Set),this.propListeners.get(e).add(t)}unsubscribeFromProp(e,t){this.propListeners.has(e)&&(this.propListeners.get(e).delete(t),0===this.propListeners.get(e).size&&this.propListeners.delete(e))}constructor(){(0,s._)(this,"state",(0,r._)({},a)),(0,s._)(this,"listeners",new Set),(0,s._)(this,"propListeners",new Map)}}},134761:function(e,t,i){i.d(t,{_:function(){return s}});function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}},520739:function(e,t,i){i.r(t),i.d(t,{_:function(){return r}});var s=i(134761);function r(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable}))),r.forEach(function(t){(0,s._)(e,t,i[t])})}return e}},878389:function(e,t,i){i.d(t,{_:function(){return s}});function s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):(function(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);i.push.apply(i,s)}return i})(Object(t)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(t,i))}),e}},368200:function(e,t,i){i.d(t,{_:function(){return r}});var s=i(495397);function r(e,t){if(null==e)return{};var i,r,a=(0,s._)(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(r=0;r<n.length;r++){if(i=n[r],!(t.indexOf(i)>=0))Object.prototype.propertyIsEnumerable.call(e,i)&&(a[i]=e[i])}}return a}},495397:function(e,t,i){i.d(t,{_:function(){return s}});function s(e,t){if(null==e)return{};var i,s,r={},a=Object.keys(e);for(s=0;s<a.length;s++)i=a[s],!(t.indexOf(i)>=0)&&(r[i]=e[i]);return r}}}]);