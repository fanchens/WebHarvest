@echo off
setlocal enabledelayedexpansion

REM Git 提交脚本 - 提交?dev 分支
REM 仓库地址: git@gitee.com:fanchenn/web-harvest.git (SSH)

set REPO_URL=git@gitee.com:fanchenn/web-harvest.git
set BRANCH=dev
set SCRIPT_DIR=%~dp0

cd /d "%SCRIPT_DIR%"

echo ========================================
echo Git 提交脚本 - 提交?dev 分支
echo ========================================
echo.

REM 自动添加 Gitee SSH 主机密钥（避免首次连接时的手动确认）
set SSH_DIR=%USERPROFILE%\.ssh
set KNOWN_HOSTS=%SSH_DIR%\known_hosts
if not exist "%SSH_DIR%" mkdir "%SSH_DIR%"
if not exist "%KNOWN_HOSTS%" (
    echo. > "%KNOWN_HOSTS%"
)
findstr /C:"gitee.com" "%KNOWN_HOSTS%" >nul 2>&1
if errorlevel 1 (
    echo 添加 Gitee SSH 主机密钥?known_hosts...
    where ssh-keyscan >nul 2>&1
    if errorlevel 1 (
        echo [WARN] 未找?ssh-keyscan 命令，首次连接时需要手动输?yes
    ) else (
        ssh-keyscan -t ed25519 gitee.com >> "%KNOWN_HOSTS%" 2>nul
        if errorlevel 1 (
            echo [WARN] 无法自动添加 SSH 主机密钥，首次连接时需要手动输?yes
        ) else (
            echo [OK] SSH 主机密钥已添?        )
    )
    echo.
)

REM 检查是否已初始?Git 仓库
if not exist ".git" (
    echo 初始?Git 仓库...
    git init
    if errorlevel 1 (
        echo [ERROR] Git 初始化失?        pause
        exit /b 1
    )
    echo [OK] Git 仓库初始化完?)

REM 检查远程仓库配?git remote | findstr /C:"origin" >nul
if errorlevel 1 (
    echo 添加远程仓库...
    git remote add origin %REPO_URL%
    if errorlevel 1 (
        echo [ERROR] 添加远程仓库失败
        pause
        exit /b 1
    )
    echo [OK] 远程仓库已添? %REPO_URL%
) else (
    REM 检查并更新远程仓库 URL（如果不同）
    for /f "tokens=*" %%u in ('git remote get-url origin 2^>nul') do set CURRENT_URL=%%u
    if not "!CURRENT_URL!"=="%REPO_URL%" (
        echo 更新远程仓库地址...
        git remote set-url origin %REPO_URL%
        if errorlevel 1 (
            echo [ERROR] 更新远程仓库地址失败
            pause
            exit /b 1
        )
        echo [OK] 远程仓库地址已更? %REPO_URL%
    ) else (
        echo [OK] 远程仓库已配? %REPO_URL%
    )
)

REM 检查当前分?for /f "tokens=*" %%i in ('git branch --show-current 2^>nul') do set CURRENT_BRANCH=%%i
if "!CURRENT_BRANCH!"=="" (
    echo 创建 dev 分支...
    git checkout -b %BRANCH%
    if errorlevel 1 (
        echo [ERROR] 创建分支失败
        pause
        exit /b 1
    )
    echo [OK] 已创建并切换?dev 分支
) else if not "!CURRENT_BRANCH!"=="%BRANCH%" (
    echo 当前分支: !CURRENT_BRANCH!
    echo 切换?dev 分支...
    git checkout -b %BRANCH% 2>nul
    if errorlevel 1 (
        git checkout %BRANCH%
        if errorlevel 1 (
            echo [ERROR] 切换分支失败
            pause
            exit /b 1
        )
    )
    echo [OK] 已切换到 dev 分支
) else (
    echo [OK] 当前已在 dev 分支
)

echo.
echo 当前 Git 状?
git status --short 2>nul

echo.

REM 检查是否有未跟踪或已修改的文件
git status --porcelain | findstr /R "." >nul 2>&1
if errorlevel 1 (
    echo [INFO] 没有需要提交的更改，工作区干净
    echo.
    REM 检查远程分支是否存?    git ls-remote --heads origin %BRANCH% >nul 2>&1
    if errorlevel 1 (
        REM 远程分支不存在，直接推?        echo 远程分支不存在，将创建并推?..
        echo.
        goto :push_only
    )
    REM 检查是否有未推送的提交
    git log origin/%BRANCH%..HEAD --oneline 2>nul | findstr /R "." >nul 2>&1
    if not errorlevel 1 (
        echo 检测到本地有未推送的提交，继续推?..
        echo.
        goto :push_only
    ) else (
        echo 本地和远程已同步，没有需要推送的内容
        pause
        exit /b 0
    )
)

REM 添加所有更?echo 添加所有更改到暂存?git add .
if errorlevel 1 (
    echo [ERROR] 添加文件失败
    pause
    exit /b 1
)
echo [OK] 文件已添加到暂存?
echo.

REM 再次检查是否有更改需要提?git status --porcelain | findstr /R "." >nul 2>&1
if errorlevel 1 (
    echo [INFO] 添加后没有需要提交的更改
    echo.
    REM 检查远程分支是否存?    git ls-remote --heads origin %BRANCH% >nul 2>&1
    if errorlevel 1 (
        REM 远程分支不存在，直接推?        echo 远程分支不存在，将创建并推?..
        echo.
        goto :push_only
    )
    REM 检查是否有未推送的提交
    git log origin/%BRANCH%..HEAD --oneline 2>nul | findstr /R "." >nul 2>&1
    if not errorlevel 1 (
        echo 检测到本地有未推送的提交，继续推?..
        echo.
        goto :push_only
    ) else (
        echo 本地和远程已同步，没有需要提交和推送的内容
        pause
        exit /b 0
    )
)

REM 获取提交信息
set /p COMMIT_MESSAGE="请输入提交信?(直接回车使用默认信息): "
if "!COMMIT_MESSAGE!"=="" (
    for /f "tokens=1-3 delims=/ " %%a in ('date /t') do set DATE_STR=%%c-%%a-%%b
    for /f "tokens=1-2 delims=: " %%a in ('time /t') do set TIME_STR=%%a:%%b
    set COMMIT_MESSAGE=Update: !DATE_STR! !TIME_STR!
)

echo.

REM 提交更改
echo 提交更改...
git commit -m "!COMMIT_MESSAGE!"
if errorlevel 1 (
    echo [WARN] 提交失败，可能是没有需要提交的更改
    REM 检查远程分支是否存?    git ls-remote --heads origin %BRANCH% >nul 2>&1
    if errorlevel 1 (
        REM 远程分支不存在，直接推?        echo 远程分支不存在，将创建并推?..
        echo.
        goto :push_only
    )
    REM 检查是否有未推送的提交
    git log origin/%BRANCH%..HEAD --oneline 2>nul | findstr /R "." >nul 2>&1
    if not errorlevel 1 (
        echo 检测到本地有未推送的提交，继续推?..
        echo.
        goto :push_only
    ) else (
        echo 本地和远程已同步，没有需要提交和推送的内容
        pause
        exit /b 0
    )
)
echo [OK] 提交成功

echo.

:push_only
REM 推送到远程仓库
echo 推送到远程仓库 (dev 分支)...
REM 检测可用的 SSH 密钥文件
set SSH_KEY_FILE=
if exist "%USERPROFILE%\.ssh\id_ed25519" (
    set SSH_KEY_FILE=%USERPROFILE%\.ssh\id_ed25519
) else if exist "%USERPROFILE%\.ssh\id_rsa" (
    set SSH_KEY_FILE=%USERPROFILE%\.ssh\id_rsa
)
REM 设置 SSH 选项，自动接受新的主机密钥，并指定使用的密钥文件
if defined SSH_KEY_FILE (
    set GIT_SSH_COMMAND=ssh -o StrictHostKeyChecking=accept-new -i "%SSH_KEY_FILE%"
) else (
    set GIT_SSH_COMMAND=ssh -o StrictHostKeyChecking=accept-new
)
git push -u origin %BRANCH% >temp_push_output.txt 2>&1
set PUSH_ERROR=%ERRORLEVEL%
type temp_push_output.txt
findstr /C:"rejected" /C:"fetch first" temp_push_output.txt >nul
if not errorlevel 1 (
    REM 推送被拒绝，使用强制推送覆盖远程分?    echo [INFO] 远程仓库有新的更改，使用强制推送覆?..
    git push -u origin %BRANCH% --force-with-lease
    if errorlevel 1 (
        echo [ERROR] 强制推送失?        del temp_push_output.txt >nul 2>&1
        set GIT_SSH_COMMAND=
        set SSH_KEY_FILE=
        pause
        exit /b 1
    )
    echo [OK] 强制推送成?) else (
    if %PUSH_ERROR% neq 0 (
        REM 其他推送错?        echo [ERROR] 推送失败，请检查网络连接和权限
        echo.
        echo 常见问题排查:
        echo 1. 如果使用的是 DeployKey（部署密钥），它只支持拉取，不支持推?        echo    需要添?SSH 公钥?Gitee 个人账户设置中（不是仓库?DeployKey?        echo 2. 检?SSH 密钥是否正确添加?Gitee 个人账户
        echo    访问: https://gitee.com/profile/sshkeys
        echo 3. 如果遇到主机密钥确认提示，请输入 yes 并重新运行脚?        echo 4. 检?Git 是否使用了正确的 SSH 密钥
        echo.
        echo 测试 SSH 连接: ssh -T git@gitee.com
        del temp_push_output.txt >nul 2>&1
        set GIT_SSH_COMMAND=
        set SSH_KEY_FILE=
        pause
        exit /b 1
    )
)
del temp_push_output.txt >nul 2>&1
set GIT_SSH_COMMAND=
set SSH_KEY_FILE=
echo [OK] 推送成?
echo.
echo ========================================
echo [OK] 所有操作完成！
echo ========================================
pause
